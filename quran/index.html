<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quran Study Platform</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">

<style>
body {
  font-family: Arial, sans-serif;
  background: #ffffff;
  color: #222;
  padding: 20px;
  transition: 0.3s;
}

.dark {
  background: #1c1c1c;
  color: #f1f1f1;
}

h1 { margin-bottom: 15px; }

.controls {
  margin-bottom: 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

select, button {
  padding: 6px 10px;
  border: 1px solid #ccc;
  background: white;
  cursor: pointer;
  font-size: 14px;
}

.primary {
  background: #2e7d32;
  color: white;
  border: none;
}

.ayah {
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 1px solid #eee;
}

.arabic {
  font-family: 'Amiri', serif;
  font-size: 26px;
  direction: rtl;
  text-align: right;
  line-height: 1.8;
  margin-bottom: 10px;
}

.word {
  cursor: pointer;
  padding: 2px 4px;
}

.word:hover {
  background: #e0f2f1;
}

.translation {
  margin-bottom: 10px;
}

.tafseer-box {
  margin-top: 10px;
  padding: 10px;
  background: #f3f6f9;
  border-left: 4px solid #2e7d32;
  font-size: 14px;
  display: none;
}

.pagination {
  margin-top: 20px;
  display: flex;
  gap: 10px;
  justify-content: center;
}

.popup {
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  padding: 8px;
  font-size: 13px;
  display: none;
  z-index: 999;
}

@media (max-width: 768px) {
  .arabic { font-size: 22px; }
  body { padding: 10px; }
}
</style>
</head>

<body>

<h1>Quran Study Platform</h1>

<div class="controls">
  <select id="surahSelect"></select>

  <select id="reciterSelect">
    <option value="Alafasy_128kbps">Mishary Alafasy</option>
    <option value="Sudais_128kbps">Sudais</option>
    <option value="Minshawi_Murattal_128kbps">Minshawi</option>
  </select>

  <button id="studyBtn" class="primary" onclick="toggleStudy()">Study Mode OFF</button>
  <button onclick="toggleDark()">Night</button>
</div>

<div id="ayahContainer"></div>

<div class="pagination">
  <button onclick="prevPage()">Previous</button>
  <button onclick="nextPage()">Next</button>
</div>

<div id="popup" class="popup"></div>

<script>
const surahSelect = document.getElementById("surahSelect");
const ayahContainer = document.getElementById("ayahContainer");
const popup = document.getElementById("popup");

let studyMode = false;
let currentPage = 1;
let versesPerPage = 20;
let totalVerses = 0;

function toggleDark() {
  document.body.classList.toggle("dark");
}

function toggleStudy() {
  studyMode = !studyMode;
  const btn = document.getElementById("studyBtn");
  btn.textContent = studyMode ? "Study Mode ON" : "Study Mode OFF";
  loadSurah(surahSelect.value);
}

async function loadSurahs() {
  const res = await fetch("https://api.quran.com/api/v4/chapters");
  const data = await res.json();

  data.chapters.forEach(ch => {
    const option = document.createElement("option");
    option.value = ch.id;
    option.textContent = ch.id + ". " + ch.name_simple;
    surahSelect.appendChild(option);
  });

  loadSurah(1);
}

async function loadSurah(id) {

  const offset = (currentPage - 1) * versesPerPage;

  const url = `https://api.quran.com/api/v4/verses/by_chapter/${id}?translations=20&fields=text_uthmani&words=true&word_fields=text_uthmani,translation,root,grammar&per_page=${versesPerPage}&page=${currentPage}`;

  const res = await fetch(url);
  const data = await res.json();

  totalVerses = data.pagination.total_records;
  ayahContainer.innerHTML = "";

  data.verses.forEach(verse => {

    let arabicHTML = "";

    if (studyMode) {
      verse.words.forEach(w => {
        arabicHTML += `<span class="word"
          onclick="showWord(event,
            '${w.translation?.text || ""}',
            '${w.root || ""}',
            '${w.grammar?.part_of_speech || ""}'
          )">
          ${w.text_uthmani}
        </span> `;
      });
    } else {
      arabicHTML = verse.text_uthmani;
    }

    const ayahNumber = verse.verse_key.split(":")[1];
    const paddedAyah = ayahNumber.padStart(3, '0');
    const paddedSurah = id.toString().padStart(3, '0');

    const div = document.createElement("div");
    div.classList.add("ayah");

    div.innerHTML = `
      <div class="arabic">${arabicHTML}</div>
      <div class="translation">${verse.translations[0].text}</div>
      <button onclick="playAudio('${paddedSurah}','${paddedAyah}')">Play</button>
      <button onclick="toggleTafseer(this)">Tafseer</button>
      <div class="tafseer-box">Tafseer coming soon (optimized loading version)</div>
    `;

    ayahContainer.appendChild(div);
  });
}

function playAudio(surah, ayah) {
  const reciter = document.getElementById("reciterSelect").value;
  const url = `https://everyayah.com/data/${reciter}/${surah}${ayah}.mp3`;

  const audio = new Audio(url);
  audio.preload = "auto";
  audio.play();
}

function toggleTafseer(btn) {
  const box = btn.nextElementSibling;
  box.style.display = box.style.display === "block" ? "none" : "block";
}

function showWord(event, meaning, root, pos) {
  popup.style.display = "block";
  popup.style.left = event.pageX + "px";
  popup.style.top = event.pageY + "px";
  popup.innerHTML = `
    <strong>Meaning:</strong> ${meaning}<br>
    <strong>Root:</strong> ${root}<br>
    <strong>Part of Speech:</strong> ${pos}
  `;
}

document.addEventListener("click", e => {
  if (!e.target.classList.contains("word")) {
    popup.style.display = "none";
  }
});

function nextPage() {
  if (currentPage * versesPerPage < totalVerses) {
    currentPage++;
    loadSurah(surahSelect.value);
  }
}

function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    loadSurah(surahSelect.value);
  }
}

surahSelect.addEventListener("change", () => {
  currentPage = 1;
  loadSurah(surahSelect.value);
});

loadSurahs();
</script>

</body>
</html>
