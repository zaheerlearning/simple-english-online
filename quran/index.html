<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quran Study Platform</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Inter',sans-serif;
  margin:0;
  background:#f4f8f6;
  color:#1f2937;
  transition:padding-bottom .3s ease;
}
.dark{background:#0f172a;color:#e5e7eb;}
body.audio-active{padding-bottom:85px;}

.header{
  position:sticky;
  top:0;
  background:white;
  padding:15px;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
  z-index:100;
}
.dark .header{background:#1e293b;}

.controls{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  justify-content:center;
  align-items:center;
}

select,button{
  padding:9px 12px;
  border-radius:8px;
  border:none;
  font-weight:500;
  cursor:pointer;
  min-height:42px;
}

button.primary{background:#2563eb;color:white;}
button.success{background:#16a34a;color:white;}
button.warning{background:#f59e0b;color:white;}
button.danger{background:#ef4444;color:white;}
button.darkbtn{background:#334155;color:white;}

.main{
  max-width:900px;
  margin:auto;
  padding:20px;
}

.ayah{
  background:white;
  padding:20px;
  border-radius:14px;
  margin-bottom:18px;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
}
.dark .ayah{background:#1e293b;}

.ayah.active{
  border-left:6px solid #16a34a;
  background:#ecfdf5;
}
.dark .ayah.active{background:#064e3b;}

.arabic{
  font-family:'Amiri',serif;
  font-size:clamp(22px,4vw,34px);
  direction:rtl;
  text-align:right;
  margin-bottom:14px;
}

.button-row{
  margin-top:10px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

/* Tafseer */
.tafseer-panel{
  position:fixed;
  top:0;
  right:0;
  width:min(480px,95vw);
  height:100vh;
  background:white;
  transform:translateX(100%);
  transition:.35s ease;
  padding:22px;
  overflow-y:auto;
  z-index:200;
  border-left:1px solid #ddd;
}
.dark .tafseer-panel{background:#1e293b;border-color:#334155;}
.tafseer-panel.open{transform:translateX(0);}

/* Mobile Floating Bar */
.audio-bar{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:white;
  box-shadow:0 -4px 12px rgba(0,0,0,0.08);
  padding:10px 15px;
  display:none;
  flex-direction:column;
  gap:6px;
  z-index:500;
}
.dark .audio-bar{background:#1e293b;}

.audio-bar.active{display:flex;}

.audio-controls{
  display:flex;
  justify-content:center;
  gap:15px;
  align-items:center;
}

.progress{
  width:100%;
  height:4px;
  background:#e5e7eb;
  border-radius:3px;
}
.progress-bar{
  height:100%;
  width:0%;
  background:#16a34a;
  border-radius:3px;
}

@media(min-width:768px){
  .audio-bar{display:none !important;}
  body.audio-active{padding-bottom:0;}
}
</style>
</head>

<body>

<div class="header">
<h2 style="text-align:center;margin-bottom:10px;">Quran Study Platform</h2>

<div class="controls">
<select id="surahSelect"></select>

<select id="reciterSelect">
<option value="Alafasy_128kbps">Mishary Al-Afasy</option>
<option value="Abdurrahmaan_As-Sudais_192kbps">Sudais</option>
<option value="Saood_ash-Shuraym_128kbps">Shuraim</option>
<option value="Maher_Al_Muaiqly_128kbps">Maher Al-Muaiqly</option>
<option value="Yasser_Ad-Dussary_128kbps">Yasser Dossary</option>
<option value="Saad_Al-Ghamdi_128kbps">Saad Al-Ghamdi</option>
<option value="Abu_Bakr_Ash-Shaatree_128kbps">Abu Bakr Ash-Shaatree</option>
<option value="Abdullah_Basfar_192kbps">Abdullah Basfar</option>
<option value="Abdul_Basit_Murattal_128kbps">Abdul Basit</option>
<option value="Minshawy_Murattal_128kbps">Minshawi</option>
<option value="Husary_128kbps">Husary</option>
<option value="Ahmed_ibn_Ali_al-Ajamy_128kbps">Ahmed Al-Ajmi</option>
<option value="Hani_Rifai_192kbps">Hani Rifai</option>
<option value="Muhammad_Ayyoub_128kbps">Muhammad Ayyoub</option>
<option value="Ali_Jaber_128kbps">Ali Jaber</option>
</select>

<button class="primary" onclick="playFullSurah()">Play</button>
<button class="warning" onclick="pauseAudio()">Pause</button>
<button class="danger" onclick="stopAudio()">Stop</button>

<select id="tafseer1">
<option value="169">Ibn Kathir</option>
<option value="168">Jalalayn</option>
<option value="165">Saadi</option>
</select>

<select id="tafseer2">
<option value="">Compare None</option>
<option value="169">Ibn Kathir</option>
<option value="168">Jalalayn</option>
<option value="165">Saadi</option>
</select>

<button class="darkbtn" onclick="toggleDark()">Night</button>
</div>
</div>

<div class="main">
<div id="ayahContainer"></div>
</div>

<div class="tafseer-panel" id="tafseerPanel">
<button onclick="closeTafseer()">Close</button>
<h3 id="tafseerHeader"></h3>
<div id="tafseerArabic"></div>
<div id="tafseerContent"></div>
</div>

<!-- Floating Mobile Bar -->
<div class="audio-bar" id="mobileBar">
<div style="font-size:14px;text-align:center;" id="mobileAyah"></div>
<div class="audio-controls">
<button onclick="prevAyah()">⏮</button>
<button onclick="resumeAudio()">▶</button>
<button onclick="pauseAudio()">⏸</button>
<button onclick="stopAudio()">⏹</button>
<button onclick="nextAyah()">⏭</button>
</div>
<div class="progress"><div class="progress-bar" id="progressBar"></div></div>
</div>

<script>
let verses=[];
let tafseerCache={};
let currentAudio=new Audio();
let currentIndex=0;
let fullMode=false;

async function loadSurahNames(){
const res=await fetch("https://api.quran.com/api/v4/chapters");
const data=await res.json();
const select=document.getElementById("surahSelect");

data.chapters.forEach(ch=>{
let opt=document.createElement("option");
opt.value=ch.id;
opt.textContent=ch.id+". "+ch.name_simple;
select.appendChild(opt);
});
loadSurah(1);
}

async function loadSurah(surah){
stopAudio();
const container=document.getElementById("ayahContainer");
container.innerHTML="Loading...";
const res=await fetch(`https://api.quran.com/api/v4/verses/by_chapter/${surah}?translations=20&fields=text_uthmani`);
const data=await res.json();
verses=data.verses;
container.innerHTML="";
verses.forEach((v,i)=>{
let div=document.createElement("div");
div.className="ayah";
div.id="ayah-"+i;
div.innerHTML=`
<div class="arabic">${v.text_uthmani}</div>
<div>${v.translations[0].text}</div>
<div class="button-row">
<button onclick="playSingle(${i})">Play</button>
<button onclick="openTafseer('${v.verse_key}','${v.text_uthmani}')">Tafseer</button>
</div>`;
container.appendChild(div);
});
}

function buildURL(key){
const reciter=document.getElementById("reciterSelect").value;
const p=key.split(":");
return `https://everyayah.com/data/${reciter}/${p[0].padStart(3,'0')}${p[1].padStart(3,'0')}.mp3`;
}

function playSingle(i){fullMode=false;playAyah(i);}
function playFullSurah(){fullMode=true;currentIndex=0;playAyah(0);}

function playAyah(i){
document.querySelectorAll(".ayah").forEach(a=>a.classList.remove("active"));
document.getElementById("ayah-"+i).classList.add("active");
currentIndex=i;
currentAudio.src=buildURL(verses[i].verse_key);
currentAudio.play();
document.body.classList.add("audio-active");
document.getElementById("mobileBar").classList.add("active");
document.getElementById("mobileAyah").innerText="Ayah "+verses[i].verse_key;
currentAudio.onended=()=>{if(fullMode && currentIndex<verses.length-1){playAyah(currentIndex+1);}};
}

function resumeAudio(){currentAudio.play();}
function pauseAudio(){currentAudio.pause();}
function stopAudio(){
currentAudio.pause();
currentAudio.currentTime=0;
fullMode=false;
document.body.classList.remove("audio-active");
document.getElementById("mobileBar").classList.remove("active");
document.querySelectorAll(".ayah").forEach(a=>a.classList.remove("active"));
}

function nextAyah(){if(currentIndex<verses.length-1)playAyah(currentIndex+1);}
function prevAyah(){if(currentIndex>0)playAyah(currentIndex-1);}

currentAudio.addEventListener("timeupdate",()=>{
let progress=(currentAudio.currentTime/currentAudio.duration)*100;
document.getElementById("progressBar").style.width=progress+"%";
});

async function openTafseer(key,arabic){
const panel=document.getElementById("tafseerPanel");
panel.classList.add("open");
document.getElementById("tafseerHeader").innerText="Tafseer "+key;
document.getElementById("tafseerArabic").innerText=arabic;
const ids=[document.getElementById("tafseer1").value,
document.getElementById("tafseer2").value].filter(Boolean);
let html="";
for(const id of ids){
const res=await fetch(`https://api.quran.com/api/v4/tafsirs/${id}/by_ayah/${key}`);
const data=await res.json();
html+=`<h4>${id==="169"?"Ibn Kathir":id==="168"?"Jalalayn":"Saadi"}</h4>${data.tafsir.text}<hr>`;
}
document.getElementById("tafseerContent").innerHTML=html;
}

function closeTafseer(){document.getElementById("tafseerPanel").classList.remove("open");}
function toggleDark(){document.body.classList.toggle("dark");}

document.getElementById("surahSelect").addEventListener("change",e=>loadSurah(e.target.value));
loadSurahNames();
</script>

</body>
</html>
