<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quran Study Platform</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Inter',sans-serif;
  margin:0;
  background:#f4f8f6;
  color:#1f2937;
}
.dark{background:#0f172a;color:#e5e7eb;}

.header{
  position:sticky;
  top:0;
  background:white;
  padding:18px;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
  z-index:100;
}
.dark .header{background:#1e293b;}

.controls{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  justify-content:center;
  align-items:center;
}

select,button{
  padding:8px 12px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-weight:500;
}

button.primary{background:#2563eb;color:white;}
button.success{background:#16a34a;color:white;}
button.warning{background:#f59e0b;color:white;}
button.danger{background:#ef4444;color:white;}
button.darkbtn{background:#334155;color:white;}

.main{
  max-width:900px;
  margin:auto;
  padding:25px;
}

.ayah{
  background:white;
  padding:22px;
  border-radius:12px;
  margin-bottom:18px;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
  transition:0.3s ease;
}
.dark .ayah{background:#1e293b;}

.ayah.active{
  border-left:6px solid #16a34a;
  background:#ecfdf5;
}
.dark .ayah.active{background:#064e3b;}

.arabic{
  font-family:'Amiri',serif;
  font-size:30px;
  direction:rtl;
  text-align:right;
  margin-bottom:14px;
}

.button-row{
  margin-top:14px;
  display:flex;
  gap:12px;
}

.tafseer-panel{
  position:fixed;
  top:0;
  right:0;
  width:min(500px,95vw);
  height:100vh;
  background:white;
  transform:translateX(100%);
  transition:transform 0.35s ease;
  padding:24px;
  overflow-y:auto;
  z-index:200;
  border-left:1px solid #ddd;
}
.dark .tafseer-panel{
  background:#1e293b;
  border-color:#334155;
}

.tafseer-panel.open{
  transform:translateX(0);
}

.spinner{
  border:4px solid #eee;
  border-top:4px solid #16a34a;
  border-radius:50%;
  width:28px;
  height:28px;
  animation:spin 1s linear infinite;
  margin:20px auto;
}
@keyframes spin{100%{transform:rotate(360deg);}}
</style>
</head>

<body>

<div class="header">
  <h2 style="text-align:center;margin-bottom:10px;">Quran Study Platform</h2>

  <div class="controls">
    <select id="surahSelect"></select>

    <label>üéß Reciter:</label>
    <select id="reciterSelect">
      <option value="Alafasy_128kbps">Mishary Al-Afasy</option>
      <option value="Abdurrahmaan_As-Sudais_192kbps">Sudais</option>
      <option value="Saood_ash-Shuraym_128kbps">Shuraim</option>
      <option value="Maher_Al_Muaiqly_128kbps">Maher</option>
      <option value="Yasser_Ad-Dussary_128kbps">Yasser Dossary</option>
      <option value="Abu_Bakr_Ash-Shaatree_128kbps">Shaatree</option>
      <option value="Saad_Al-Ghamdi_128kbps">Saad Ghamdi</option>
      <option value="Abdullah_Basfar_192kbps">Basfar</option>
      <option value="Abdul_Basit_Mujawwad_128kbps">Abdul Basit</option>
      <option value="Minshawy_Murattal_128kbps">Minshawi</option>
      <option value="Husary_128kbps">Husary</option>
      <option value="Ahmed_ibn_Ali_al-Ajamy_128kbps">Ajmi</option>
      <option value="Hani_Rifai_192kbps">Hani Rifai</option>
      <option value="Nasser_Alqatami_128kbps">Qatami</option>
      <option value="Muhammad_Ayyoub_128kbps">Ayyoub</option>
      <option value="Ali_Jaber_128kbps">Ali Jaber</option>
    </select>

    <button class="primary" onclick="playFullSurah()">‚ñ∂ Play Surah</button>
    <button class="warning" onclick="pauseAudio()">‚è∏ Pause</button>
    <button class="danger" onclick="stopAudio()">‚èπ Stop</button>

    <label>Tafseer 1:</label>
    <select id="tafseer1">
      <option value="169">Ibn Kathir</option>
      <option value="168">Jalalayn</option>
      <option value="164">Maarif-ul-Quran</option>
    </select>

    <label>Compare:</label>
    <select id="tafseer2">
      <option value="">None</option>
      <option value="169">Ibn Kathir</option>
      <option value="168">Jalalayn</option>
      <option value="164">Maarif-ul-Quran</option>
    </select>

    <button class="darkbtn" onclick="toggleDark()">Night</button>
  </div>
</div>

<div class="main">
  <div id="ayahContainer"></div>
</div>

<div class="tafseer-panel" id="tafseerPanel">
  <button class="danger" onclick="closeTafseer()">‚úñ Close</button>
  <h3 id="tafseerHeader"></h3>
  <div id="tafseerArabic" style="font-family:Amiri;direction:rtl;text-align:right;margin:12px 0;"></div>
  <button class="warning" onclick="copyTafseer()">Copy Tafseer</button>
  <div id="tafseerContent"></div>
</div>

<script>
let verses=[];
let tafseerCache={};
let currentAudio=new Audio();
let currentIndex=0;
let fullMode=false;
let currentTafseerText="";

async function loadSurahNames(){
  const res=await fetch("https://api.quran.com/api/v4/chapters");
  const data=await res.json();
  const select=document.getElementById("surahSelect");

  data.chapters.forEach(ch=>{
    let opt=document.createElement("option");
    opt.value=ch.id;
    opt.textContent=ch.id+". "+ch.name_simple;
    select.appendChild(opt);
  });

  loadSurah(1);
}

async function loadSurah(surah){
  stopAudio();
  const container=document.getElementById("ayahContainer");
  container.innerHTML="Loading...";

  const res=await fetch(
    `https://api.quran.com/api/v4/verses/by_chapter/${surah}?translations=20&fields=text_uthmani`
  );
  const data=await res.json();
  verses=data.verses;
  container.innerHTML="";

  verses.forEach((v,i)=>{
    let div=document.createElement("div");
    div.className="ayah";
    div.id="ayah-"+i;

    div.innerHTML=`
      <div class="arabic">${v.text_uthmani}</div>
      <div>${v.translations[0].text}</div>
      <div class="button-row">
        <button class="primary" onclick="playSingle(${i})">Play</button>
        <button class="success" onclick="openTafseer('${v.verse_key}','${v.text_uthmani}')">üìñ Tafseer</button>
      </div>
    `;
    container.appendChild(div);
  });
}

function buildURL(verseKey){
  const reciter=document.getElementById("reciterSelect").value;
  const p=verseKey.split(":");
  return `https://everyayah.com/data/${reciter}/${p[0].padStart(3,'0')}${p[1].padStart(3,'0')}.mp3`;
}

function playSingle(i){
  fullMode=false;
  playAyah(i);
}

function playFullSurah(){
  fullMode=true;
  currentIndex=0;
  playAyah(currentIndex);
}

function playAyah(i){
  document.querySelectorAll(".ayah").forEach(a=>a.classList.remove("active"));
  document.getElementById("ayah-"+i).classList.add("active");

  currentIndex=i;
  currentAudio.src=buildURL(verses[i].verse_key);
  currentAudio.play();

  currentAudio.onended=()=>{
    if(fullMode && currentIndex<verses.length-1){
      playAyah(currentIndex+1);
    }
  };
}

function pauseAudio(){currentAudio.pause();}
function stopAudio(){
  currentAudio.pause();
  currentAudio.currentTime=0;
  fullMode=false;
  document.querySelectorAll(".ayah").forEach(a=>a.classList.remove("active"));
}

async function openTafseer(key,arabicText){
  const panel=document.getElementById("tafseerPanel");
  panel.classList.add("open");

  document.getElementById("tafseerHeader").textContent="Tafseer for "+key;
  document.getElementById("tafseerArabic").textContent=arabicText;
  document.getElementById("tafseerContent").innerHTML='<div class="spinner"></div>';

  const ids=[document.getElementById("tafseer1").value,
             document.getElementById("tafseer2").value].filter(Boolean);

  let html="";

  for(const id of ids){
    const cacheKey=id+"-"+key;
    if(!tafseerCache[cacheKey]){
      const res=await fetch(`https://api.quran.com/api/v4/tafsirs/${id}/by_ayah/${key}`);
      const data=await res.json();
      tafseerCache[cacheKey]=data.tafsir.text;
    }
    html+=`<h4>${id==="169"?"Ibn Kathir":id==="168"?"Jalalayn":"Maarif-ul-Quran"}</h4>${tafseerCache[cacheKey]}<hr>`;
  }

  currentTafseerText=html;
  document.getElementById("tafseerContent").innerHTML=html;
}

function closeTafseer(){
  document.getElementById("tafseerPanel").classList.remove("open");
}

function copyTafseer(){
  navigator.clipboard.writeText(currentTafseerText);
}

function toggleDark(){
  document.body.classList.toggle("dark");
}

document.addEventListener("keydown",e=>{
  if(e.key==="Escape") closeTafseer();
});

document.getElementById("surahSelect").addEventListener("change",e=>{
  loadSurah(e.target.value);
});

loadSurahNames();
</script>

</body>
</html>
