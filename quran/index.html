<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quran Study Platform</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --emerald:#0f766e;
  --emerald-soft:#0d9488;
  --bg-light:#f6f8f7;
  --card-light:#ffffff;
  --bg-dark:#0b1220;
  --card-dark:#121a2b;
  --text-light:#1f2937;
  --text-dark:#e5e7eb;
  --arabic-dark:#f3efe6;
}

body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:var(--bg-light);
  color:var(--text-light);
  transition:.3s ease;
}

.dark{
  background:var(--bg-dark);
  color:var(--text-dark);
}

header{
  position:sticky;
  top:0;
  background:var(--card-light);
  padding:15px;
  box-shadow:0 2px 12px rgba(0,0,0,0.06);
  z-index:100;
}
.dark header{ background:var(--card-dark); }

h2{ text-align:center; margin:0 0 12px 0; }

.controls-row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
  margin-bottom:8px;
}

select,button{
  padding:10px 16px;
  border-radius:10px;
  border:none;
  font-weight:600;
  cursor:pointer;
}

button{
  background:var(--emerald);
  color:white;
}
button:hover{ background:var(--emerald-soft); }

.warning{ background:#f59e0b; }
.danger{ background:#dc2626; }
.secondary{ background:#334155; }

main{
  max-width:850px;
  margin:auto;
  padding:20px;
}

.ayah{
  background:var(--card-light);
  padding:22px;
  border-radius:16px;
  margin-bottom:20px;
  box-shadow:0 4px 18px rgba(0,0,0,0.05);
}
.dark .ayah{ background:var(--card-dark); }

.arabic{
  font-family:'Amiri',serif;
  font-size:clamp(24px,4vw,34px);
  direction:rtl;
  text-align:right;
  margin-bottom:14px;
}
.dark .arabic{ color:var(--arabic-dark); }

.translation{ margin-top:6px; line-height:1.6; }
.urdu{ direction:rtl; }

.button-row{
  margin-top:14px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

/* FIXED TAFSEER PANEL */
.tafseer-panel{
  position:fixed;
  top:0;
  right:0;
  width:100%;
  height:100%;
  background:var(--card-light);
  transform:translateX(100%);
  transition:.3s ease;
  overflow-y:auto;
  padding:20px;
  z-index:200;
}
.dark .tafseer-panel{ background:var(--card-dark); }

@media(min-width:900px){
  .tafseer-panel{
    width:450px;
  }
}

.tafseer-panel.open{
  transform:translateX(0);
}

.close-btn{
  background:#dc2626;
  margin-bottom:12px;
}
</style>
</head>

<body>

<header>
<h2>Quran Study Platform</h2>

<div class="controls-row">
<select id="surahSelect"></select>

<select id="reciterSelect">
<option value="Alafasy_128kbps">Mishary Rashid Al-Afasy</option>
<option value="Abdurrahmaan_As-Sudais_192kbps">Abdur-Rahman Al-Sudais</option>
<option value="Saood_ash-Shuraym_128kbps">Saud Al-Shuraim</option>
<option value="Maher_Al_Muaiqly_128kbps">Maher Al-Muaiqly</option>
<option value="Husary_128kbps">Mahmoud Khalil Al-Husary</option>
<option value="Abdul_Basit_Mujawwad_128kbps">Abdul Basit (Mujawwad)</option>
<option value="Abdul_Basit_Murattal_192kbps">Abdul Basit (Murattal)</option>
</select>

<button onclick="playFullSurah()">Play</button>
<button class="warning" onclick="pauseAudio()">Pause</button>
<button class="danger" onclick="stopAudio()">Stop</button>
</div>

<div class="controls-row">
<label><input type="checkbox" id="showEnglish" checked> English</label>
<label><input type="checkbox" id="showTaqi"> Urdu (Taqi)</label>
<label><input type="checkbox" id="showJalandhari"> Urdu (Jalandhari)</label>

<select id="tafseerSelect">
<option value="169">Ibn Kathir (English)</option>
<option value="168">Jalalayn (English)</option>
</select>

<button class="secondary" onclick="toggleDark()">Night</button>
</div>
</header>

<main>
<div id="ayahContainer"></div>
</main>

<div class="tafseer-panel" id="tafseerPanel">
<button class="close-btn" onclick="closeTafseer()">Close</button>
<h3 id="tafseerHeader"></h3>
<div id="tafseerContent"></div>
</div>

<script>
let verses=[];
let audio=new Audio();
let currentIndex=0;
let fullMode=false;

async function loadSurahNames(){
const res=await fetch("https://api.quran.com/api/v4/chapters");
const data=await res.json();
const select=document.getElementById("surahSelect");
data.chapters.forEach(ch=>{
let opt=document.createElement("option");
opt.value=ch.id;
opt.textContent=ch.id+". "+ch.name_simple;
select.appendChild(opt);
});
loadSurah(1);
}

async function loadSurah(id){
stopAudio();
const res=await fetch(
`https://api.quran.com/api/v4/verses/by_chapter/${id}?translations=20,131,97&translation_fields=text,resource_id&fields=text_uthmani`
);
const data=await res.json();
verses=data.verses || [];
render();
}

function render(){
const container=document.getElementById("ayahContainer");
container.innerHTML="";

const showEnglish=document.getElementById("showEnglish").checked;
const showTaqi=document.getElementById("showTaqi").checked;
const showJalandhari=document.getElementById("showJalandhari").checked;

verses.forEach((v,i)=>{
let english="", taqi="", jalandhari="";

if(v.translations){
v.translations.forEach(t=>{
// SAFE detection (resource_id OR fallback name match)
if(t.resource_id==20 || t.resource_name?.toLowerCase().includes("sahih")) english=t.text;
if(t.resource_id==131 || t.resource_name?.toLowerCase().includes("taqi")) taqi=t.text;
if(t.resource_id==97 || t.resource_name?.toLowerCase().includes("jaland")) jalandhari=t.text;
});
}

let div=document.createElement("div");
div.className="ayah";
div.innerHTML=`
<div class="arabic">${v.text_uthmani}</div>
${showEnglish?`<div class="translation">${english}</div>`:""}
${showTaqi?`<div class="translation urdu">${taqi}</div>`:""}
${showJalandhari?`<div class="translation urdu">${jalandhari}</div>`:""}
<div class="button-row">
<button onclick="playSingle(${i})">Play</button>
<button onclick="openTafseer('${v.verse_key}')">Tafseer</button>
</div>
`;
container.appendChild(div);
});
}

document.querySelectorAll("#showEnglish,#showTaqi,#showJalandhari")
.forEach(el=>el.addEventListener("change",render));

function buildURL(key){
const reciter=document.getElementById("reciterSelect").value;
const [s,a]=key.split(":");
return `https://everyayah.com/data/${reciter}/${s.padStart(3,"0")}${a.padStart(3,"0")}.mp3`;
}

function playSingle(i){ fullMode=false; play(i); }
function playFullSurah(){ fullMode=true; currentIndex=0; play(0); }

function play(i){
if(!verses[i]) return;
currentIndex=i;
audio.src=buildURL(verses[i].verse_key);
audio.play();
audio.onended=()=>{ if(fullMode && currentIndex<verses.length-1){ play(currentIndex+1); } };
}

function pauseAudio(){ audio.pause(); }
function stopAudio(){ audio.pause(); audio.currentTime=0; }

async function openTafseer(key){
const panel=document.getElementById("tafseerPanel");
panel.classList.add("open");
document.body.style.overflow="hidden";

document.getElementById("tafseerHeader").innerText="Tafseer "+key;

const id=document.getElementById("tafseerSelect").value;
const res=await fetch(`https://api.quran.com/api/v4/tafsirs/${id}/by_ayah/${key}`);
const data=await res.json();
document.getElementById("tafseerContent").innerHTML=data.tafsir?.text || "Not available";
}

function closeTafseer(){
document.getElementById("tafseerPanel").classList.remove("open");
document.body.style.overflow="";
}

function toggleDark(){
document.body.classList.toggle("dark");
}

document.getElementById("surahSelect").addEventListener("change",e=>loadSurah(e.target.value));

loadSurahNames();
</script>

</body>
</html>
