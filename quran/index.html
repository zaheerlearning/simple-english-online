<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quran Study Platform</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">

<style>
body { font-family: Arial; padding:20px; background:#fff; color:#222; }
.dark { background:#1c1c1c; color:#eee; }
.controls { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:20px; }
button, select, input { padding:6px 10px; }
.ayah { margin-bottom:25px; border-bottom:1px solid #ddd; padding-bottom:15px; }
.arabic { font-family:'Amiri',serif; font-size:28px; direction:rtl; text-align:right; margin-bottom:8px; }
.tafseer-box { margin-top:10px; display:none; }
footer { margin-top:40px; font-size:13px; border-top:1px solid #ccc; padding-top:20px; }
.word { cursor:pointer; padding:2px 4px; }
.word:hover { background:#e0f2f1; }
#wordPopup {
  position:absolute;
  background:#fff;
  border:1px solid #ccc;
  padding:10px;
  font-size:13px;
  display:none;
  z-index:1000;
  max-width:250px;
}
.dark #wordPopup { background:#333; color:#fff; }
</style>
</head>

<body>

<h2>Quran Study Platform</h2>

<div class="controls">

<input type="text" id="ayahJump" placeholder="Jump (e.g. 2:255)">
<button onclick="jumpToAyah()">Go</button>

<select id="surahSelect"></select>

<select id="reciterSelect">
<option value="Alafasy_128kbps">Mishary Alafasy</option>
<option value="Sudais_128kbps">Sudais</option>
<option value="Minshawi_Murattal_128kbps">Minshawi</option>
</select>

<select id="tafseer1">
<option value="169">Ibn Kathir</option>
<option value="168">Jalalayn</option>
</select>

<select id="tafseer2">
<option value="">No Compare</option>
<option value="169">Ibn Kathir</option>
<option value="168">Jalalayn</option>
</select>

<button onclick="toggleStudy()" id="studyBtn">Study OFF</button>
<button onclick="toggleDark()">Night</button>

</div>

<div id="ayahContainer"></div>

<div id="wordPopup"></div>

<footer>
<b>Attribution & Disclaimer</b><br><br>
Arabic text, translation, and tafseer fetched via Quran.com API.<br>
All rights belong to respective authors and publishers.<br>
This platform is a study tool and does not replace qualified scholarly guidance.
</footer>

<script>

let studyMode = false;
let tafseerCache = {};
let currentAudio = null;

/* Load Surah Names */
async function loadSurahNames(){
  const res = await fetch("https://api.quran.com/api/v4/chapters");
  const data = await res.json();
  const select = document.getElementById("surahSelect");

  data.chapters.forEach(ch=>{
    let opt = document.createElement("option");
    opt.value = ch.id;
    opt.textContent = ch.id + ". " + ch.name_simple;
    select.appendChild(opt);
  });

  loadSurah(1);
}

/* Load Surah */
async function loadSurah(surah){
  const container = document.getElementById("ayahContainer");
  container.innerHTML = "Loading...";

  const res = await fetch(
    `https://api.quran.com/api/v4/verses/by_chapter/${surah}?translations=20&words=true&word_fields=text_uthmani,translation,root,grammar&fields=text_uthmani`
  );

  const data = await res.json();
  container.innerHTML = "";

  data.verses.forEach(v=>{

    let arabicHTML = "";

    if(studyMode){
      v.words.forEach(w=>{
        arabicHTML += `
          <span class="word"
            onclick="showWordInfo(event,
              '${w.translation?.text || ""}',
              '${w.root || ""}',
              '${w.grammar?.part_of_speech || ""}'
            )">
            ${w.text_uthmani}
          </span> `;
      });
    } else {
      arabicHTML = v.text_uthmani;
    }

    let div = document.createElement("div");
    div.className = "ayah";

    div.innerHTML = `
      <div class="arabic">${arabicHTML}</div>
      <div>${v.translations[0].text}</div>
      <button onclick="playAyah('${v.verse_key}')">Play</button>
      <button onclick="toggleTafseer('${v.verse_key}', this)">Tafseer</button>
      <div class="tafseer-box"></div>
    `;

    container.appendChild(div);
  });
}

/* Study Toggle */
function toggleStudy(){
  studyMode = !studyMode;
  document.getElementById("studyBtn").textContent =
    studyMode ? "Study ON" : "Study OFF";
  loadSurah(document.getElementById("surahSelect").value);
}

/* Dark Mode */
function toggleDark(){
  document.body.classList.toggle("dark");
}

/* Audio */
function playAyah(verseKey){
  const reciter = document.getElementById("reciterSelect").value;
  const parts = verseKey.split(":");
  const surah = parts[0].padStart(3,'0');
  const ayah = parts[1].padStart(3,'0');
  const url = `https://everyayah.com/data/${reciter}/${surah}${ayah}.mp3`;

  if(currentAudio) currentAudio.pause();
  currentAudio = new Audio(url);
  currentAudio.play();
}

/* Tafseer */
async function toggleTafseer(verseKey, btn){

  const box = btn.nextElementSibling;

  if(box.style.display === "block"){
    box.style.display = "none";
    return;
  }

  box.style.display = "block";
  box.innerHTML = "Loading...";

  const t1 = document.getElementById("tafseer1").value;
  const t2 = document.getElementById("tafseer2").value;
  const selected = [t1, t2].filter(Boolean);

  let html = "";

  if(selected.length === 2){
    html = `<div style="display:flex; gap:15px;">`;
    for(const t of selected){
      const cacheKey = t + "-" + verseKey;
      if(!tafseerCache[cacheKey]){
        const res = await fetch(`https://api.quran.com/api/v4/tafsirs/${t}/by_ayah/${verseKey}`);
        const data = await res.json();
        tafseerCache[cacheKey] = data.tafsir.text;
      }
      const label = (t==="169")?"Ibn Kathir":"Jalalayn";
      html += `
        <div style="flex:1; background:#f3f6f9; padding:10px;">
          <b>${label}</b><br><br>
          ${tafseerCache[cacheKey]}
        </div>
      `;
    }
    html += `</div>`;
  } else {
    const t = selected[0];
    const cacheKey = t + "-" + verseKey;
    if(!tafseerCache[cacheKey]){
      const res = await fetch(`https://api.quran.com/api/v4/tafsirs/${t}/by_ayah/${verseKey}`);
      const data = await res.json();
      tafseerCache[cacheKey] = data.tafsir.text;
    }
    const label = (t==="169")?"Ibn Kathir":"Jalalayn";
    html = `
      <div style="background:#f3f6f9; padding:10px;">
        <b>${label}</b><br><br>
        ${tafseerCache[cacheKey]}
      </div>
    `;
  }

  box.innerHTML = html;
}

/* Word Popup */
function showWordInfo(event, meaning, root, pos){
  const popup = document.getElementById("wordPopup");
  popup.style.display = "block";
  popup.style.left = event.pageX + "px";
  popup.style.top = event.pageY + "px";
  popup.innerHTML = `
    <b>Meaning:</b> ${meaning || "—"}<br>
    <b>Root:</b> ${root || "—"}<br>
    <b>Part of Speech:</b> ${pos || "—"}
  `;
}

document.addEventListener("click", function(e){
  if(!e.target.classList.contains("word")){
    document.getElementById("wordPopup").style.display = "none";
  }
});

/* Ayah Jump */
function jumpToAyah(){
  const input = document.getElementById("ayahJump").value;
  if(!input.includes(":")) return;

  const [s,a] = input.split(":");
  document.getElementById("surahSelect").value = s;
  loadSurah(s);

  setTimeout(()=>{
    const ayah = document.querySelectorAll(".ayah")[a-1];
    if(ayah) ayah.scrollIntoView({behavior:"smooth"});
  },800);
}

document.getElementById("surahSelect").addEventListener("change", e=>{
  loadSurah(e.target.value);
});

loadSurahNames();

</script>
</body>
</html>
