<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quran Study Platform</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#0f766e;
  --bg:#f7f9f8;
  --card:#ffffff;
  --dark-bg:#0e1624;
  --dark-card:#151e2e;
}

body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:var(--bg);
  transition:.3s;
}
.dark{ background:var(--dark-bg); color:#e5e7eb; }

header{
  position:sticky;
  top:0;
  background:var(--card);
  padding:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.05);
  z-index:100;
}
.dark header{ background:var(--dark-card); }

h2{text-align:center;margin:0 0 10px;}

.controls{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  justify-content:center;
  margin-bottom:8px;
}

select,button{
  padding:8px 12px;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
}

button{
  background:var(--primary);
  color:white;
}
button:hover{opacity:.9;}

.warning{ background:#f59e0b; }
.danger{ background:#dc2626; }
.secondary{ background:#334155; }

main{
  max-width:900px;
  margin:auto;
  padding:20px;
}

.ayah{
  background:var(--card);
  padding:22px;
  border-radius:16px;
  margin-bottom:20px;
  box-shadow:0 4px 16px rgba(0,0,0,.04);
}
.dark .ayah{ background:var(--dark-card); }

.ayah.active{
  border-left:5px solid var(--primary);
}

.arabic{
  font-family:'Amiri',serif;
  font-size:clamp(24px,4vw,34px);
  direction:rtl;
  text-align:right;
  line-height:2.1;
  margin-bottom:12px;
}

.translation{ margin-top:6px; }
.urdu{ direction:rtl; }

.button-row{
  margin-top:10px;
  display:flex;
  gap:10px;
}

/* Tafsir Hybrid */
.tafsir-page{
  position:fixed;
  top:0;
  right:0;
  height:100dvh;
  width:100%;
  background:var(--card);
  display:flex;
  flex-direction:column;
  transform:translateX(100%);
  transition:.35s ease;
  z-index:3000;
}
.dark .tafsir-page{ background:var(--dark-card); }

.tafsir-page.open{ transform:translateX(0); }

.tafsir-header{
  padding:16px;
  border-bottom:1px solid rgba(0,0,0,.08);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.tafsir-content{
  flex:1;
  overflow-y:auto;
  padding:20px;
}

@media(min-width:900px){
  .tafsir-page{
    width:480px;
    border-left:1px solid rgba(0,0,0,.1);
  }
}
</style>
</head>

<body>

<header>
<h2>Quran Study Platform</h2>

<div class="controls">
<select id="surahSelect"></select>

<select id="reciterSelect">
<option value="Alafasy_128kbps">Mishary Rashid Al-Afasy</option>
<option value="Abdurrahmaan_As-Sudais_192kbps">Sudais</option>
<option value="Saood_ash-Shuraym_128kbps">Shuraim</option>
<option value="Maher_Al_Muaiqly_128kbps">Maher</option>
<option value="Husary_128kbps">Husary</option>
<option value="Abdul_Basit_Mujawwad_128kbps">Abdul Basit (Mujawwad)</option>
<option value="Abdul_Basit_Murattal_192kbps">Abdul Basit (Murattal)</option>
</select>

<button onclick="playFullSurah()">Play</button>
<button class="warning" onclick="pauseAudio()">Pause</button>
<button class="danger" onclick="stopAudio()">Stop</button>
</div>

<div class="controls">
<label><input type="checkbox" id="showEnglish" checked> English</label>
<label><input type="checkbox" id="showUrdu"> Urdu</label>

<select id="tafseerSelect">
<option value="169">Ibn Kathir</option>
<option value="168">Jalalayn</option>
</select>

<button class="secondary" onclick="toggleDark()">Night</button>
</div>
</header>

<main>
<div id="ayahContainer"></div>
</main>

<div class="tafsir-page" id="tafsirPage">
  <div class="tafsir-header">
    <div id="tafsirTitle"></div>
    <button onclick="closeTafsir()">Close</button>
  </div>
  <div class="tafsir-content" id="tafsirContent"></div>
</div>

<script>
let verses=[];
let chaptersData=[];
let audio=new Audio();
let currentIndex=0;
let fullMode=false;

/* Load Surah Names */
async function loadSurahNames(){
  const res=await fetch("https://api.quran.com/api/v4/chapters");
  const data=await res.json();
  chaptersData=data.chapters;

  const select=document.getElementById("surahSelect");
  data.chapters.forEach(ch=>{
    let opt=document.createElement("option");
    opt.value=ch.id;
    opt.textContent=ch.id+". "+ch.name_simple;
    select.appendChild(opt);
  });

  loadSurah(1);
}

/* Load Surah */
async function loadSurah(id){
  stopAudio();
  const res=await fetch(`https://api.quran.com/api/v4/verses/by_chapter/${id}?translations=20,97&fields=text_uthmani`);
  const data=await res.json();
  verses=data.verses||[];
  render();
}

/* Render */
function render(){
  const container=document.getElementById("ayahContainer");
  container.innerHTML="";
  const showEnglish=document.getElementById("showEnglish").checked;
  const showUrdu=document.getElementById("showUrdu").checked;

  verses.forEach((v,i)=>{
    let english="", urdu="";
    v.translations?.forEach(t=>{
      if(t.resource_id==20) english=t.text;
      if(t.resource_id==97) urdu=t.text;
    });

    let div=document.createElement("div");
    div.className="ayah";
    div.innerHTML=`
      <div class="arabic">${v.text_uthmani}</div>
      ${showEnglish?`<div class="translation">${english}</div>`:""}
      ${showUrdu?`<div class="translation urdu">${urdu}</div>`:""}
      <div class="button-row">
        <button onclick="playSingle(${i})">Play</button>
        <button onclick="openTafsir('${v.verse_key}')">Tafsir</button>
      </div>
    `;
    container.appendChild(div);
  });
}

document.querySelectorAll("#showEnglish,#showUrdu")
.forEach(el=>el.addEventListener("change",render));

/* Audio */
function buildURL(key){
  const reciter=document.getElementById("reciterSelect").value;
  const [s,a]=key.split(":");
  return `https://everyayah.com/data/${reciter}/${s.padStart(3,"0")}${a.padStart(3,"0")}.mp3`;
}

function playSingle(i){ fullMode=false; play(i); }
function playFullSurah(){ fullMode=true; currentIndex=0; play(0); }

function play(i){
  if(!verses[i]) return;
  document.querySelectorAll(".ayah").forEach(a=>a.classList.remove("active"));
  const ayah=document.querySelectorAll(".ayah")[i];
  ayah.classList.add("active");
  ayah.scrollIntoView({behavior:"smooth",block:"center"});
  currentIndex=i;
  audio.src=buildURL(verses[i].verse_key);
  audio.play();
  audio.onended=()=>{ if(fullMode&&currentIndex<verses.length-1) play(currentIndex+1); };
}

function pauseAudio(){ audio.pause(); }
function stopAudio(){ audio.pause(); audio.currentTime=0; }

/* Tafsir */
async function openTafsir(verseKey){
  const page=document.getElementById("tafsirPage");
  page.classList.add("open");
  document.body.style.overflow="hidden";

  const [surahNumber, ayahNumber]=verseKey.split(":");
  const surah=chaptersData.find(c=>c.id==surahNumber);

  const tafsirSelect=document.getElementById("tafseerSelect");
  const tafsirName=tafsirSelect.options[tafsirSelect.selectedIndex].text;

  document.getElementById("tafsirTitle").innerHTML=`
    <div style="font-weight:600;">Surah ${surah.name_simple} (${surah.id})</div>
    <div style="direction:rtl;margin-top:4px;">${surah.name_arabic}</div>
    <div style="font-size:14px;margin-top:6px;opacity:.7;">
      Ayah ${ayahNumber} â€” Tafsir ${tafsirName}
    </div>
  `;

  const id=tafsirSelect.value;
  const res=await fetch(`https://api.quran.com/api/v4/tafsirs/${id}/by_ayah/${verseKey}`);
  const data=await res.json();
  document.getElementById("tafsirContent").innerHTML=
    data.tafsir?.text || "Tafsir not available.";
}

function closeTafsir(){
  document.getElementById("tafsirPage").classList.remove("open");
  document.body.style.overflow="auto";
}

function toggleDark(){
  document.body.classList.toggle("dark");
}

document.getElementById("surahSelect")
.addEventListener("change",e=>loadSurah(e.target.value));

loadSurahNames();
</script>

</body>
</html>
