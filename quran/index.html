<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quran Study Platform</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Inter', sans-serif;
  margin:0;
  background:#f6fbf8;
  color:#1f2937;
}

.dark { background:#0f172a; color:#e5e7eb; }

/* Header */
.header {
  position:sticky;
  top:0;
  background:white;
  padding:15px;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
  z-index:100;
}
.dark .header { background:#1e293b; }

.controls {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
}

button, select {
  padding:6px 12px;
  border-radius:6px;
  border:none;
  cursor:pointer;
}

button.play { background:#2563eb; color:white; }
button.taf { background:#16a34a; color:white; }
button.copy { background:#f59e0b; color:white; }
button.close { background:#ef4444; color:white; }
button.roman { background:#9333ea; color:white; }

/* Layout */
.layout {
  display:flex;
  min-height:100vh;
}

/* Main */
.main {
  flex:1;
  padding:20px;
  transition:0.3s ease;
}

/* Ayah Card */
.ayah {
  background:white;
  padding:20px;
  border-radius:10px;
  margin-bottom:15px;
  transition:0.3s;
}
.dark .ayah { background:#1e293b; }

.ayah.highlight {
  border-left:6px solid #16a34a;
  background:#ecfdf5;
}
.dark .ayah.highlight {
  background:#064e3b;
}

.arabic {
  font-family:'Amiri', serif;
  font-size:28px;
  direction:rtl;
  text-align:right;
  margin-bottom:10px;
}

/* Tafseer Panel (Desktop Split Layout) */
.tafseer-panel {
  width:0;
  overflow:hidden;
  background:white;
  border-left:1px solid #e5e7eb;
  transition:width 0.3s ease;
  padding:0;
}

.dark .tafseer-panel {
  background:#1e293b;
  border-left:1px solid #334155;
}

.tafseer-panel.open {
  width:420px;
  padding:20px;
}

.tafseer-header-arabic {
  font-family:'Amiri', serif;
  font-size:22px;
  direction:rtl;
  text-align:right;
  margin:10px 0;
}

.spinner {
  border:4px solid #eee;
  border-top:4px solid #16a34a;
  border-radius:50%;
  width:30px;
  height:30px;
  animation:spin 1s linear infinite;
  margin:20px auto;
}

@keyframes spin {
  100% { transform:rotate(360deg); }
}

/* Mobile: Drawer Mode */
@media(max-width:768px){
  .layout { flex-direction:column; }

  .tafseer-panel.open {
    position:fixed;
    right:0;
    top:0;
    width:100%;
    height:100%;
    z-index:200;
  }
}
</style>
</head>

<body>

<div class="header">
  <h2 style="text-align:center;">Quran Study Platform</h2>
  <div class="controls">

    <select id="surahSelect"></select>

    <select id="reciterSelect">
      <option value="Alafasy_128kbps">Mishary Alafasy</option>
      <option value="Sudais_128kbps">Sudais</option>
      <option value="Minshawi_Murattal_128kbps">Minshawi</option>
    </select>

    <select id="tafseer1">
      <option value="169">Ibn Kathir</option>
      <option value="168">Jalalayn</option>
    </select>

    <select id="tafseer2">
      <option value="">No Compare</option>
      <option value="169">Ibn Kathir</option>
      <option value="168">Jalalayn</option>
    </select>

    <button class="roman" onclick="toggleRoman()">Roman Urdu</button>
    <button onclick="toggleDark()">Night</button>

  </div>
</div>

<div class="layout">

  <div class="main">
    <div id="ayahContainer"></div>
  </div>

  <div class="tafseer-panel" id="tafseerPanel">
    <button class="close" onclick="closeTafseer()">âœ– Close</button>
    <h3 id="tafseerHeader"></h3>
    <div id="tafseerArabic" class="tafseer-header-arabic"></div>
    <button class="copy" onclick="copyTafseer()">Copy Tafseer</button>
    <div id="tafseerContent"></div>
  </div>

</div>

<script>
let surahMetaData=[];
let surahVerses=[];
let tafseerCache={};
let currentTafseerText="";
let romanMode=false;

/* Load Surahs */
async function loadSurahNames(){
  const res=await fetch("https://api.quran.com/api/v4/chapters");
  const data=await res.json();
  surahMetaData=data.chapters;
  const select=document.getElementById("surahSelect");

  data.chapters.forEach(ch=>{
    let opt=document.createElement("option");
    opt.value=ch.id;
    opt.textContent=ch.id+". "+ch.name_simple;
    select.appendChild(opt);
  });

  loadSurah(1);
}

/* Load Surah */
async function loadSurah(surah){
  const container=document.getElementById("ayahContainer");
  container.innerHTML="Loading...";

  const res=await fetch(
    `https://api.quran.com/api/v4/verses/by_chapter/${surah}?translations=20&fields=text_uthmani`
  );
  const data=await res.json();
  surahVerses=data.verses;
  container.innerHTML="";

  surahVerses.forEach(v=>{
    let div=document.createElement("div");
    div.className="ayah";
    div.id="ayah-"+v.verse_key;

    let translation=v.translations[0].text;

    if(romanMode){
      translation=translation
        .replace(/Lord/g,"Rab")
        .replace(/Merciful/g,"Rehmat Wala");
    }

    div.innerHTML=`
      <div class="arabic">${v.text_uthmani}</div>
      <div>${translation}</div>
      <button class="play" onclick="playAyah('${v.verse_key}')">Play</button>
      <button class="taf" onclick="openTafseer('${v.verse_key}','${v.text_uthmani}')">ðŸ“– Tafseer</button>
    `;

    container.appendChild(div);
  });
}

/* Roman Mode */
function toggleRoman(){
  romanMode=!romanMode;
  loadSurah(document.getElementById("surahSelect").value);
}

/* Audio */
function playAyah(key){
  const reciter=document.getElementById("reciterSelect").value;
  const p=key.split(":");
  const url=`https://everyayah.com/data/${reciter}/${p[0].padStart(3,'0')}${p[1].padStart(3,'0')}.mp3`;
  new Audio(url).play();
}

/* Tafseer */
async function openTafseer(key, arabicText){
  document.querySelectorAll(".ayah").forEach(a=>a.classList.remove("highlight"));
  const ayahEl=document.getElementById("ayah-"+key);
  ayahEl.classList.add("highlight");
  ayahEl.scrollIntoView({behavior:"smooth", block:"center"});

  const panel=document.getElementById("tafseerPanel");
  const content=document.getElementById("tafseerContent");
  const header=document.getElementById("tafseerHeader");
  const arabicHeader=document.getElementById("tafseerArabic");

  panel.classList.add("open");
  header.textContent="Tafseer for "+key;
  arabicHeader.textContent=arabicText;

  content.innerHTML='<div class="spinner"></div>';

  const t1=document.getElementById("tafseer1").value;
  const t2=document.getElementById("tafseer2").value;
  const selected=[t1,t2].filter(Boolean);

  let html="";
  for(const t of selected){
    const cacheKey=t+"-"+key;
    if(!tafseerCache[cacheKey]){
      const res=await fetch(`https://api.quran.com/api/v4/tafsirs/${t}/by_ayah/${key}`);
      const data=await res.json();
      tafseerCache[cacheKey]=data.tafsir.text;
    }
    const label=(t==="169")?"Ibn Kathir":"Jalalayn";
    html+=`<h4>${label}</h4>${tafseerCache[cacheKey]}<hr>`;
  }

  currentTafseerText=html;
  content.innerHTML=html;
}

function closeTafseer(){
  document.getElementById("tafseerPanel").classList.remove("open");
  document.querySelectorAll(".ayah").forEach(a=>a.classList.remove("highlight"));
}

function copyTafseer(){
  navigator.clipboard.writeText(currentTafseerText);
  alert("Copied!");
}

function toggleDark(){
  document.body.classList.toggle("dark");
}

document.getElementById("surahSelect").addEventListener("change",e=>{
  loadSurah(e.target.value);
});

loadSurahNames();
</script>

</body>
</html>
