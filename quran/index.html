<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quran Study Platform</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#0f766e;
  --primary-soft:#0d9488;
  --bg:#f7f9f8;
  --card:#ffffff;
  --dark-bg:#0e1624;
  --dark-card:#151e2e;
  --text:#1f2937;
  --text-dark:#e5e7eb;
}

body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:var(--bg);
  color:var(--text);
  transition:.3s;
}

.dark{
  background:var(--dark-bg);
  color:var(--text-dark);
}

header{
  position:sticky;
  top:0;
  background:var(--card);
  padding:16px;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
  z-index:100;
}
.dark header{ background:var(--dark-card); }

h2{text-align:center;margin:0 0 10px;font-weight:600;}

.controls{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  justify-content:center;
  margin-bottom:8px;
}

select,button{
  padding:10px 14px;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
}

button{
  background:var(--primary);
  color:white;
}
button:hover{ background:var(--primary-soft); }

.warning{ background:#f59e0b; }
.danger{ background:#dc2626; }
.secondary{ background:#334155; }

main{
  max-width:900px;
  margin:auto;
  padding:20px;
}

.ayah{
  background:var(--card);
  padding:22px;
  border-radius:16px;
  margin-bottom:20px;
  box-shadow:0 4px 16px rgba(0,0,0,0.04);
}

.dark .ayah{ background:var(--dark-card); }

.ayah.active{
  border-left:6px solid var(--primary);
  background:#e6fffa;
}

.dark .ayah.active{
  background:#063c37;
}

.arabic{
  font-family:'Amiri',serif;
  font-size:clamp(24px,4vw,34px);
  direction:rtl;
  text-align:right;
  margin-bottom:12px;
  line-height:2.1;
}

/* Study Mode FIXED */
.study-mode .arabic{
  direction:rtl;
  text-align:right;
  white-space:normal;
  word-spacing:0;
  letter-spacing:0;
}

.study-mode .word{
  display:inline;
  padding:2px 4px;
  border-radius:6px;
  cursor:pointer;
  transition:.15s;
}

.study-mode .word:hover{
  background:#e0f2f1;
}

.dark .study-mode .word:hover{
  background:#064e3b;
}

.active-word{
  background:#a7f3d0 !important;
}

.translation{
  margin-top:6px;
  line-height:1.6;
}

.urdu{ direction:rtl; }

.button-row{
  margin-top:12px;
  display:flex;
  gap:10px;
}

/* Tafseer Drawer */
.tafseer-panel{
  position:fixed;
  top:0;
  right:0;
  width:100%;
  height:100dvh;
  background:var(--card);
  transform:translateX(100%);
  transition:.35s;
  overflow-y:auto;
  padding:24px 24px 80px;
  z-index:2000;
}

.dark .tafseer-panel{ background:var(--dark-card); }

@media(min-width:900px){
  .tafseer-panel{ width:480px; }
}

.tafseer-panel.open{
  transform:translateX(0);
}

/* Study Bottom Sheet */
#studyPanel{
  position:fixed;
  bottom:-100%;
  left:0;
  width:100%;
  background:var(--card);
  border-top:3px solid var(--primary);
  padding:18px;
  box-shadow:0 -6px 18px rgba(0,0,0,0.15);
  transition:bottom .35s ease;
  z-index:2500;
}

.dark #studyPanel{ background:var(--dark-card); }

#studyPanel.open{
  bottom:0;
}
</style>
</head>

<body>

<header>
<h2>Quran Study Platform</h2>

<div class="controls">
<select id="surahSelect"></select>

<select id="reciterSelect">
<option value="Alafasy_128kbps">Mishary Rashid Al-Afasy</option>
<option value="Abdurrahmaan_As-Sudais_192kbps">Sudais</option>
<option value="Saood_ash-Shuraym_128kbps">Shuraim</option>
<option value="Maher_Al_Muaiqly_128kbps">Maher</option>
<option value="Husary_128kbps">Husary</option>
<option value="Abdul_Basit_Mujawwad_128kbps">Abdul Basit (Mujawwad)</option>
<option value="Abdul_Basit_Murattal_192kbps">Abdul Basit (Murattal)</option>
</select>

<button onclick="playFullSurah()">Play</button>
<button class="warning" onclick="pauseAudio()">Pause</button>
<button class="danger" onclick="stopAudio()">Stop</button>
<button id="studyToggle">Study Mode</button>
</div>

<div class="controls">
<label><input type="checkbox" id="showEnglish" checked> English</label>
<label><input type="checkbox" id="showUrdu"> Urdu</label>

<select id="tafseerSelect">
<option value="169">Ibn Kathir</option>
<option value="168">Jalalayn</option>
</select>

<button class="secondary" onclick="toggleDark()">Night</button>
</div>
</header>

<main>
<div id="ayahContainer"></div>
</main>

<div class="tafseer-panel" id="tafseerPanel">
<button onclick="closeTafseer()">Close</button>
<h3 id="tafseerHeader"></h3>
<div id="tafseerContent"></div>
</div>

<div id="studyPanel">
<div id="studyContent"></div>
<button onclick="closeStudyPanel()">Close</button>
</div>

<script>
let verses=[];
let audio=new Audio();
let currentIndex=0;
let fullMode=false;
let studyMode=false;

async function loadSurahNames(){
const res=await fetch("https://api.quran.com/api/v4/chapters");
const data=await res.json();
const select=document.getElementById("surahSelect");
data.chapters.forEach(ch=>{
let opt=document.createElement("option");
opt.value=ch.id;
opt.textContent=ch.id+". "+ch.name_simple;
select.appendChild(opt);
});
loadSurah(1);
}

async function loadSurah(id){
stopAudio();
let url=studyMode
? `https://api.quran.com/api/v4/verses/by_chapter/${id}?translations=20,97&words=true&word_fields=text,translation,transliteration,root`
: `https://api.quran.com/api/v4/verses/by_chapter/${id}?translations=20,97&fields=text_uthmani`;

const res=await fetch(url);
const data=await res.json();
verses=data.verses||[];
render();
}

function render(){
const container=document.getElementById("ayahContainer");
container.innerHTML="";

const showEnglish=document.getElementById("showEnglish").checked;
const showUrdu=document.getElementById("showUrdu").checked;

verses.forEach((v,i)=>{
let english="", urdu="";
if(v.translations){
v.translations.forEach(t=>{
if(t.resource_id==20) english=t.text;
if(t.resource_id==97) urdu=t.text;
});
}

let arabicHTML="";
if(studyMode && v.words){
arabicHTML=v.words.map(w=>{
return `<span class="word"
onclick="openWord(this,'${w.text||""}','${w.translation?.text||""}','${w.transliteration?.text||""}','${w.root||""}')">
${w.text||""}
</span>`;
}).join("");
}else{
arabicHTML=v.text_uthmani||"";
}

let div=document.createElement("div");
div.className="ayah";
div.innerHTML=`
<div class="arabic">${arabicHTML}</div>
${showEnglish?`<div class="translation">${english}</div>`:""}
${showUrdu?`<div class="translation urdu">${urdu}</div>`:""}
<div class="button-row">
<button onclick="playSingle(${i})">Play</button>
<button onclick="openTafseer('${v.verse_key}')">Tafseer</button>
</div>`;
container.appendChild(div);
});
}

document.querySelectorAll("#showEnglish,#showUrdu")
.forEach(el=>el.addEventListener("change",render));

document.getElementById("studyToggle").addEventListener("click",()=>{
studyMode=!studyMode;
document.body.classList.toggle("study-mode");
loadSurah(document.getElementById("surahSelect").value);
});

function openWord(el,a,m,t,r){
document.querySelectorAll(".word").forEach(w=>w.classList.remove("active-word"));
el.classList.add("active-word");
document.getElementById("studyContent").innerHTML=
`<strong style="font-size:22px;">${a}</strong><br><br>
Meaning: ${m}<br>
Transliteration: ${t}<br>
Root: ${r}`;
document.getElementById("studyPanel").classList.add("open");
}

function closeStudyPanel(){
document.getElementById("studyPanel").classList.remove("open");
}

function buildURL(key){
const reciter=document.getElementById("reciterSelect").value;
const [s,a]=key.split(":");
return `https://everyayah.com/data/${reciter}/${s.padStart(3,"0")}${a.padStart(3,"0")}.mp3`;
}

function playSingle(i){ fullMode=false; play(i); }
function playFullSurah(){ fullMode=true; currentIndex=0; play(0); }

function play(i){
if(!verses[i]) return;
document.querySelectorAll(".ayah").forEach(a=>a.classList.remove("active"));
const ayah=document.querySelectorAll(".ayah")[i];
ayah.classList.add("active");
ayah.scrollIntoView({behavior:"smooth",block:"center"});
currentIndex=i;
audio.src=buildURL(verses[i].verse_key);
audio.play();
audio.onended=()=>{ if(fullMode&&currentIndex<verses.length-1) play(currentIndex+1); };
}

function pauseAudio(){ audio.pause(); }
function stopAudio(){ audio.pause(); audio.currentTime=0; }

async function openTafseer(key){
document.getElementById("tafseerPanel").classList.add("open");
document.body.style.overflow="hidden";
document.getElementById("tafseerHeader").innerText="Tafseer "+key;
const id=document.getElementById("tafseerSelect").value;
const res=await fetch(`https://api.quran.com/api/v4/tafsirs/${id}/by_ayah/${key}`);
const data=await res.json();
document.getElementById("tafseerContent").innerHTML=data.tafsir?.text||"Not available";
}

function closeTafseer(){
document.getElementById("tafseerPanel").classList.remove("open");
document.body.style.overflow="auto";
}

function toggleDark(){ document.body.classList.toggle("dark"); }

document.getElementById("surahSelect")
.addEventListener("change",e=>loadSurah(e.target.value));

loadSurahNames();
</script>

</body>
</html>
