<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quran Study Platform</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Inter', sans-serif;
  margin:0;
  background:#f6fbf8;
  color:#1f2937;
}

.dark { background:#0f172a; color:#e5e7eb; }

/* Layout */
.wrapper {
  display:flex;
}

/* Main Content */
.main {
  flex:1;
  padding:20px;
  transition:0.3s;
}

/* Tafseer Panel */
.tafseer-panel {
  width:0;
  overflow:hidden;
  background:#ffffff;
  border-left:1px solid #ddd;
  transition:0.3s ease;
  padding:0;
}

.dark .tafseer-panel {
  background:#1e293b;
  border-left:1px solid #334155;
}

.tafseer-panel.open {
  width:400px;
  padding:20px;
}

.tafseer-content {
  max-height:80vh;
  overflow-y:auto;
  font-size:14px;
  line-height:1.6;
}

.close-btn {
  cursor:pointer;
  font-size:18px;
  float:right;
}

/* Header */
.header {
  position:sticky;
  top:0;
  background:white;
  padding:15px;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
  z-index:100;
}

.dark .header { background:#1e293b; }

.controls {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
}

button {
  padding:6px 12px;
  border-radius:6px;
  border:none;
  cursor:pointer;
}

button.play { background:#2563eb; color:white; }
button.taf { background:#16a34a; color:white; }

.arabic {
  font-family:'Amiri', serif;
  font-size:28px;
  direction:rtl;
  text-align:right;
  margin-bottom:10px;
}

.ayah {
  background:white;
  padding:20px;
  border-radius:10px;
  margin-bottom:15px;
}

.dark .ayah { background:#1e293b; }

/* Mobile */
@media(max-width:900px){
  .tafseer-panel.open {
    width:100%;
    position:fixed;
    right:0;
    top:0;
    height:100%;
    z-index:200;
  }
}
</style>
</head>

<body>

<div class="header">
  <h2 style="text-align:center;">Quran Study Platform</h2>
  <div class="controls">
    <select id="surahSelect"></select>

    <select id="tafseer1">
      <option value="169">Ibn Kathir</option>
      <option value="168">Jalalayn</option>
    </select>

    <select id="tafseer2">
      <option value="">No Compare</option>
      <option value="169">Ibn Kathir</option>
      <option value="168">Jalalayn</option>
    </select>

    <button onclick="toggleDark()">Night</button>
  </div>
</div>

<div class="wrapper">

  <div class="main" id="mainContent">
    <div id="ayahContainer"></div>
  </div>

  <div class="tafseer-panel" id="tafseerPanel">
    <div>
      <span class="close-btn" onclick="closeTafseer()">âœ–</span>
      <h3>Tafseer</h3>
      <hr>
      <div class="tafseer-content" id="tafseerContent"></div>
    </div>
  </div>

</div>

<script>

let surahMetaData = [];
let surahVerses = [];
let tafseerCache = {};

/* Load Surahs */
async function loadSurahNames(){
  const res = await fetch("https://api.quran.com/api/v4/chapters");
  const data = await res.json();
  surahMetaData = data.chapters;

  const select = document.getElementById("surahSelect");
  data.chapters.forEach(ch=>{
    let opt = document.createElement("option");
    opt.value = ch.id;
    opt.textContent = ch.id + ". " + ch.name_simple;
    select.appendChild(opt);
  });

  loadSurah(1);
}

/* Load Surah */
async function loadSurah(surah){
  const container = document.getElementById("ayahContainer");
  container.innerHTML = "Loading...";

  const res = await fetch(
    `https://api.quran.com/api/v4/verses/by_chapter/${surah}?translations=20&fields=text_uthmani`
  );

  const data = await res.json();
  surahVerses = data.verses;
  container.innerHTML = "";

  surahVerses.forEach(v=>{
    let div = document.createElement("div");
    div.className = "ayah";
    div.innerHTML = `
      <div class="arabic">${v.text_uthmani}</div>
      <div>${v.translations[0].text}</div>
      <button class="play" onclick="playAyah('${v.verse_key}')">Play</button>
      <button class="taf" onclick="openTafseer('${v.verse_key}')">ðŸ“– Tafseer</button>
    `;
    container.appendChild(div);
  });
}

/* Tafseer Panel Logic */
async function openTafseer(verseKey){

  const panel = document.getElementById("tafseerPanel");
  const content = document.getElementById("tafseerContent");

  panel.classList.add("open");
  content.innerHTML = "Loading...";

  const t1 = document.getElementById("tafseer1").value;
  const t2 = document.getElementById("tafseer2").value;

  let html = "";

  const selected = [t1, t2].filter(Boolean);

  if(selected.length === 2){
    html = `<div style="display:flex; gap:10px;">`;

    for(const t of selected){
      const cacheKey = t + "-" + verseKey;

      if(!tafseerCache[cacheKey]){
        const res = await fetch(
          `https://api.quran.com/api/v4/tafsirs/${t}/by_ayah/${verseKey}`
        );
        const data = await res.json();
        tafseerCache[cacheKey] = data.tafsir.text;
      }

      const label = (t==="169")?"Ibn Kathir":"Jalalayn";

      html += `
        <div style="flex:1; background:#f3f4f6; padding:10px;">
          <b>${label}</b><br><br>
          ${tafseerCache[cacheKey]}
        </div>
      `;
    }

    html += "</div>";

  } else {

    const t = selected[0];
    const cacheKey = t + "-" + verseKey;

    if(!tafseerCache[cacheKey]){
      const res = await fetch(
        `https://api.quran.com/api/v4/tafsirs/${t}/by_ayah/${verseKey}`
      );
      const data = await res.json();
      tafseerCache[cacheKey] = data.tafsir.text;
    }

    const label = (t==="169")?"Ibn Kathir":"Jalalayn";

    html = `
      <b>${label}</b><br><br>
      ${tafseerCache[cacheKey]}
    `;
  }

  content.innerHTML = html;
}

function closeTafseer(){
  document.getElementById("tafseerPanel").classList.remove("open");
}

function toggleDark(){
  document.body.classList.toggle("dark");
}

function playAyah(verseKey){
  const parts = verseKey.split(":");
  const url =
    "https://everyayah.com/data/Alafasy_128kbps/" +
    parts[0].padStart(3,'0') +
    parts[1].padStart(3,'0') + ".mp3";

  new Audio(url).play();
}

document.getElementById("surahSelect").addEventListener("change", e=>{
  loadSurah(e.target.value);
});

loadSurahNames();

</script>

</body>
</html>
