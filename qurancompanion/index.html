
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quran Companion</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#166534">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Quran Companion">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
:root{
  --primary:#166534;
  --accent:#22c55e;
  --bg:#f0fdf4;
  --card:#ffffff;
  --dark:#053d2a;
}
*{ box-sizing:border-box; }
body{ margin:0; font-family:'Inter',sans-serif; background:var(--bg); }

/* â•â• STICKY TOP â•â• */
#stickyTop{ position:sticky; top:0; z-index:100; }

/* â•â• HEADER â•â• */
header{
  background:linear-gradient(135deg,#166534,#065f46);
  color:white; padding:10px 12px 8px;
}
h2{ text-align:center; margin:0 0 8px; font-size:clamp(15px,3vw,20px); }
.header-top{ margin-bottom:6px; }
.header-selects{
  display:flex; gap:6px; margin-bottom:6px;
}
.header-selects select{
  flex:1; min-width:0;
}
.header-btns{
  display:flex; gap:6px; justify-content:center;
}
.header-btns button{
  flex:1; max-width:90px;
  padding:7px 6px; font-size:12px;
}
select,button,label{
  padding:7px 10px; border:none;
  border-radius:10px; font-weight:600; cursor:pointer;
  font-family:inherit; font-size:13px;
}
button{ background:var(--accent); color:white; }
#studyBtn.active{ background:#15803d; outline:2px solid white; }

/* â•â• PRAYER BAR â•â• */
#prayerBar{
  background:linear-gradient(135deg,var(--dark),#064e3b);
  color:white; box-shadow:0 4px 14px rgba(0,0,0,.25);
}

/* Date/time row - always visible */
.p-datetime-row{
  display:flex; align-items:center; justify-content:center;
  gap:0; padding:5px 14px 5px;
  flex-wrap:nowrap; overflow:hidden;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.p-dt-item{
  display:flex; align-items:center; gap:4px;
  padding:2px 8px; flex-shrink:0;
  font-size:11px;
}
.p-dt-item:not(:last-child){
  border-right:1px solid rgba(255,255,255,.2);
}
.p-dt-label{ opacity:.6; font-size:9px; text-transform:uppercase; letter-spacing:.5px; }
.p-dt-value{ font-weight:700; font-size:11px; }
#pClock{ font-size:13px; font-weight:700; letter-spacing:.5px; }

/* Collapsed strip */
.p-strip{
  display:flex; align-items:center;
  padding:7px 10px; gap:0; cursor:pointer;
}
.p-strip-col{
  display:flex; flex-direction:column;
  flex:1; min-width:0; padding:0 6px;
}
.p-strip-center{ align-items:center; }
.p-strip-btns{
  display:flex; align-items:center;
  gap:5px; flex-shrink:0; padding-left:6px;
}
.p-vline{
  width:1px; height:36px;
  background:rgba(255,255,255,.2);
  flex-shrink:0;
}
.p-label{ font-size:9px; text-transform:uppercase; letter-spacing:.6px; opacity:.6; margin-bottom:1px; }
.p-name{ font-size:13px; font-weight:700; line-height:1.3; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.p-curr{ font-size:12px !important; }
.p-time{ font-size:10px; opacity:.75; }
.p-countdown{
  background:rgba(255,255,255,.18);
  padding:3px 10px; border-radius:20px;
  font-size:13px; font-weight:700;
  letter-spacing:.4px; min-width:56px; text-align:center;
  margin-top:2px;
}
.p-icon-btn{
  background:rgba(255,255,255,.12); border:none; color:white;
  border-radius:8px; padding:5px 9px;
  cursor:pointer; font-size:14px; line-height:1; flex-shrink:0;
}
.p-icon-btn:hover{ background:rgba(255,255,255,.25); }

/* Expanded panel */
.p-panel{ display:none; padding:0 14px 14px; border-top:1px solid rgba(255,255,255,.08); }
.p-panel.open{ display:block; }

/* 7-grid */
.p-grid{
  display:grid; grid-template-columns:repeat(7,1fr);
  gap:5px; margin-top:10px;
}
.p-cell{
  background:rgba(255,255,255,.1); border-radius:10px;
  padding:8px 3px; text-align:center; transition:.2s;
}
.p-cell.current{ background:rgba(255,255,255,.28); outline:2px solid rgba(255,255,255,.55); }
.p-cell.passed{ opacity:.4; }
.p-cell-icon{ font-size:12px; margin-bottom:2px; }
.p-cell-name{ font-size:9px; text-transform:uppercase; letter-spacing:.3px; opacity:.7; margin-bottom:2px; }
.p-cell-time{ font-size:11px; font-weight:700; }

/* City row */
.p-city-row{ display:flex; gap:6px; align-items:center; margin-top:12px; }
.p-city-input{
  flex:1; padding:6px 10px; border-radius:8px;
  border:1px solid rgba(255,255,255,.2);
  background:rgba(255,255,255,.12); color:white;
  font-size:12px; font-family:inherit; outline:none;
}
.p-city-input::placeholder{ color:rgba(255,255,255,.4); }
.p-city-input:focus{ border-color:rgba(255,255,255,.5); background:rgba(255,255,255,.18); }
.p-search-btn{ padding:6px 12px; border-radius:8px; background:var(--accent); color:white; border:none; font-weight:700; font-size:12px; cursor:pointer; }
.p-gps-btn{ padding:6px 9px; border-radius:8px; background:rgba(255,255,255,.15); color:white; border:1px solid rgba(255,255,255,.2); font-size:12px; cursor:pointer; }
.p-location{ font-size:11px; opacity:.55; width:100%; padding-top:3px; }

/* Settings */
.p-settings{ display:flex; flex-wrap:wrap; gap:7px; margin-top:8px; }
.p-settings select{
  background:rgba(255,255,255,.12); color:white;
  border:1px solid rgba(255,255,255,.2);
  font-size:11px; padding:5px 7px; border-radius:8px; flex:1; min-width:130px;
}
.p-settings select option{ background:var(--dark); color:white; }

/* Azan row */
.p-azan-row{ display:flex; gap:8px; align-items:center; margin-top:7px; }
.p-azan-label{ font-size:11px; font-weight:600; opacity:.8; white-space:nowrap; flex-shrink:0; }
.p-azan-row select{
  flex:1; background:rgba(255,255,255,.12); color:white;
  border:1px solid rgba(255,255,255,.2);
  font-size:11px; padding:5px 7px; border-radius:8px;
}
.p-azan-row select option{ background:var(--dark); }

/* Masjid + Qibla buttons */
.p-tools-row{ display:flex; gap:8px; margin-top:10px; }
.p-tool-btn{
  flex:1; padding:8px; border-radius:10px;
  background:rgba(255,255,255,.12); color:white;
  border:1px solid rgba(255,255,255,.2);
  font-size:12px; font-weight:600; cursor:pointer;
  text-align:center; transition:.2s;
}
.p-tool-btn:hover{ background:rgba(255,255,255,.22); }

/* Masjid list */
.masjid-list{ margin-top:10px; display:none; }
.masjid-list.open{ display:block; }
.masjid-item{
  background:rgba(255,255,255,.1); border-radius:8px;
  padding:8px 10px; margin-bottom:5px; font-size:12px;
}
.masjid-name{ font-weight:700; margin-bottom:2px; }
.masjid-dist{ opacity:.7; font-size:11px; }

/* â•â• HADITH CARD â•â• */
#hadithCard{
  max-width:1000px; margin:12px auto 0;
  padding:0 15px;
}
.hadith-card-inner{
  background:linear-gradient(135deg,#064e3b,#065f46);
  border-radius:14px; color:white;
  overflow:hidden;
  box-shadow:0 4px 14px rgba(0,0,0,.12);
}
.hadith-header{
  display:flex; align-items:center;
  justify-content:space-between;
  padding:10px 14px; cursor:pointer;
  gap:10px;
}
.hadith-header-left{ display:flex; align-items:center; gap:8px; flex:1; min-width:0; }
.hadith-title{ font-weight:700; font-size:13px; white-space:nowrap; }
.hadith-preview{
  font-size:12px; opacity:.75;
  white-space:nowrap; overflow:hidden;
  text-overflow:ellipsis; flex:1;
}
.hadith-tabs-bar{
  display:none; border-top:1px solid rgba(255,255,255,.1);
  padding:0 14px;
}
.hadith-tabs-bar.open{ display:flex; gap:0; }
.h-tab{
  padding:8px 14px; font-size:12px; font-weight:600;
  cursor:pointer; opacity:.6; border-bottom:2px solid transparent;
  background:none; border-left:none; border-right:none; border-top:none;
  color:white; transition:.2s;
}
.h-tab.active{ opacity:1; border-bottom-color:var(--accent); }
.hadith-body{ display:none; padding:14px; border-top:1px solid rgba(255,255,255,.1); }
.hadith-body.open{ display:block; }
.hadith-text{ font-size:13px; line-height:1.8; margin-bottom:10px; }
.hadith-meta{
  font-size:11px; opacity:.7;
  background:rgba(255,255,255,.1); padding:6px 10px;
  border-radius:8px; display:inline-block;
}
.hadith-search-row{ display:flex; gap:6px; margin-bottom:10px; }
.hadith-search-input{
  flex:1; padding:7px 10px; border-radius:8px;
  border:1px solid rgba(255,255,255,.2);
  background:rgba(255,255,255,.12); color:white;
  font-size:12px; font-family:inherit; outline:none;
}
.hadith-search-input::placeholder{ color:rgba(255,255,255,.4); }
.hadith-search-btn{ padding:7px 12px; border-radius:8px; background:var(--accent); color:white; border:none; font-weight:700; font-size:12px; cursor:pointer; }
.hadith-result{
  background:rgba(255,255,255,.1); border-radius:8px;
  padding:10px; margin-bottom:8px; font-size:12px; line-height:1.7;
}
.hadith-result-meta{ font-size:10px; opacity:.65; margin-top:5px; }

/* â•â• MAIN â•â• */
main{ max-width:1000px; margin:auto; padding:15px; }
.ayah{
  background:var(--card); padding:20px;
  border-radius:16px; margin-bottom:18px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  transition:.3s; position:relative;
}
.playing{ background:#ecfdf5; border:2px solid var(--accent); }
.bookmark{ position:absolute; top:10px; left:10px; cursor:pointer; font-size:18px; }
.bookmarked{ color:gold; }
.arabic{
  font-family:'Amiri',serif;
  font-size:clamp(22px,4vw,34px);
  direction:rtl; text-align:right; line-height:2;
}
.translation{ margin-top:8px; color:#374151; font-size:15px; }
.word{ cursor:pointer; padding:2px 4px; border-radius:6px; display:inline-block; }
.word:hover{ background:#bbf7d0; }

/* Word popup */
.word-popup{
  position:fixed; bottom:-100%; left:0; width:100%;
  background:white; padding:20px;
  box-shadow:0 -5px 25px rgba(0,0,0,.25);
  transition:.3s; z-index:11000; line-height:1.8;
}
.word-popup.show{ bottom:0; }

/* Audio floater */
.audio-floater{
  position:fixed; bottom:-130px; left:0; width:100%;
  background:white; padding:12px 16px;
  display:flex; flex-direction:column; gap:6px;
  box-shadow:0 -4px 20px rgba(0,0,0,.2);
  transition:.3s; z-index:9999;
}
.audio-floater.show{ bottom:0; }
.progress-bar{ height:6px; background:#e5e7eb; border-radius:5px; overflow:hidden; }
.progress{ height:100%; width:0%; background:var(--accent); }
.floater-controls{ display:flex; justify-content:space-between; align-items:center; }

/* â•â• TAFSIR PANEL â•â• */
.tafsir-panel{
  position:fixed; top:0; right:-660px;
  width:640px; height:100%;
  background:white; transition:.3s;
  z-index:10000; display:flex; flex-direction:column;
  box-shadow:-4px 0 20px rgba(0,0,0,.15);
}
.tafsir-panel.open{ right:0; }
.tafsir-header{
  background:var(--primary); color:white;
  padding:14px 16px; flex-shrink:0;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.tafsir-header span{ flex:1; font-weight:600; }
.tafsir-header button{ flex-shrink:0; background:rgba(255,255,255,.2); color:white; padding:6px 14px; }
.tafsir-toolbar{
  background:#f0fdf4; border-bottom:1px solid #d1fae5;
  padding:10px 16px; display:flex;
  flex-wrap:wrap; align-items:center; gap:10px; flex-shrink:0;
}
.tafsir-toolbar label{ font-weight:600; color:var(--primary); cursor:pointer; display:flex; align-items:center; gap:6px; padding:0; }
.tafsir-toolbar select{ padding:6px 10px; border:1px solid #d1fae5; background:white; font-size:13px; border-radius:8px; }
.tafsir-toolbar select:disabled{ opacity:.4; cursor:not-allowed; }
.tafsir-body{ padding:20px; overflow-y:auto; flex:1; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; }
.tafsir-tabs{ display:none; border-bottom:2px solid #d1fae5; background:#f0fdf4; flex-shrink:0; }
.tafsir-tabs.show{ display:flex; }
.tafsir-tab{
  flex:1; padding:10px; text-align:center; font-weight:600; font-size:13px;
  cursor:pointer; border:none; background:transparent; color:#6b7280;
  border-bottom:3px solid transparent; margin-bottom:-2px; transition:.2s;
}
.tafsir-tab.active{ color:var(--primary); border-bottom-color:var(--primary); background:white; }
.tafsir-box{ background:#f9fafb; padding:15px; border-radius:10px; overflow-wrap:break-word; line-height:1.75; }
.tafsir-box h3{ margin:0 0 10px; color:var(--primary); font-size:13px; text-transform:uppercase; letter-spacing:.5px; border-bottom:2px solid #d1fae5; padding-bottom:8px; }

/* â•â• BOT PANEL â•â• */
#botBtn{
  position:fixed; bottom:24px; right:24px;
  width:54px; height:54px; border-radius:50%;
  background:linear-gradient(135deg,#166534,#22c55e);
  color:white; border:none; font-size:22px;
  cursor:pointer; z-index:9998;
  box-shadow:0 4px 16px rgba(22,101,52,.4);
  display:flex; align-items:center; justify-content:center;
  transition:.2s;
}
#botBtn:hover{ transform:scale(1.08); }

.bot-panel{
  position:fixed; top:0; right:-420px;
  width:400px; height:100%;
  background:white; transition:.3s;
  z-index:10001; display:flex; flex-direction:column;
  box-shadow:-4px 0 20px rgba(0,0,0,.15);
}
.bot-panel.open{ right:0; }
.bot-header{
  background:var(--primary); color:white;
  padding:14px 16px; flex-shrink:0;
  display:flex; align-items:center; justify-content:space-between;
}
.bot-header-left{ display:flex; flex-direction:column; }
.bot-header h3{ margin:0; font-size:16px; }
.bot-header small{ opacity:.75; font-size:11px; margin-top:2px; }
.bot-header button{ background:rgba(255,255,255,.2); color:white; padding:6px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
.bot-messages{
  flex:1; overflow-y:auto; padding:16px;
  display:flex; flex-direction:column; gap:10px;
  background:#f8fafc;
}
.bot-msg{
  max-width:85%; padding:10px 13px;
  border-radius:14px; font-size:13px; line-height:1.6;
}
.bot-msg.user{
  align-self:flex-end;
  background:var(--primary); color:white;
  border-bottom-right-radius:4px;
}
.bot-msg.assistant{
  align-self:flex-start;
  background:white; color:#1f2937;
  border-bottom-left-radius:4px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}
.bot-msg.assistant.loading{ opacity:.6; }
.bot-disclaimer{
  padding:8px 14px; font-size:10px; color:#6b7280;
  background:#f0fdf4; border-top:1px solid #d1fae5;
  text-align:center; flex-shrink:0;
}
.bot-input-row{
  display:flex; gap:8px; padding:12px;
  border-top:1px solid #e5e7eb; flex-shrink:0; background:white;
}
.bot-input{
  flex:1; padding:9px 12px; border-radius:10px;
  border:1px solid #d1fae5; font-size:13px;
  font-family:inherit; outline:none;
  resize:none; max-height:80px;
}
.bot-input:focus{ border-color:var(--accent); }
.bot-send-btn{
  padding:9px 14px; border-radius:10px;
  background:var(--primary); color:white;
  border:none; font-size:16px; cursor:pointer;
  flex-shrink:0;
}
.bot-send-btn:hover{ background:#15803d; }
.bot-send-btn:disabled{ opacity:.5; cursor:not-allowed; }

/* â•â• QIBLA OVERLAY â•â• */
#qiblaOverlay{
  position:fixed; inset:0; z-index:10002;
  background:rgba(0,0,0,.7);
  display:none; align-items:center; justify-content:center;
}
#qiblaOverlay.open{ display:flex; }
.qibla-box{
  background:white; border-radius:20px;
  padding:24px; text-align:center;
  max-width:300px; width:90%;
}
.qibla-box h3{ margin:0 0 6px; color:var(--primary); font-size:18px; }
.qibla-box p{ margin:0 0 16px; font-size:12px; color:#6b7280; }
.compass-wrap{
  width:200px; height:200px; margin:0 auto 16px;
  position:relative;
}
.compass-rose{
  width:100%; height:100%; border-radius:50%;
  background:linear-gradient(135deg,#f0fdf4,#dcfce7);
  border:3px solid var(--primary);
  position:relative; transition:transform .5s ease;
}
.compass-n{
  position:absolute; top:6px; left:50%; transform:translateX(-50%);
  font-size:11px; font-weight:700; color:var(--primary);
}
.compass-needle{
  position:absolute; top:50%; left:50%;
  transform:translate(-50%,-100%);
  transform-origin:bottom center;
  width:0; height:0;
}
.needle-north{
  width:4px; height:80px; background:red;
  border-radius:4px 4px 0 0;
  position:absolute; left:-2px; bottom:0;
}
.needle-south{
  width:4px; height:60px; background:#aaa;
  border-radius:0 0 4px 4px;
  position:absolute; left:-2px; top:0;
}
.kaaba-icon{
  position:absolute; font-size:24px;
  top:50%; left:50%; transform:translate(-50%,-50%);
}
.qibla-degrees{
  font-size:28px; font-weight:700; color:var(--primary);
  margin-bottom:4px;
}
.qibla-direction{ font-size:13px; color:#6b7280; margin-bottom:16px; }
.qibla-close-btn{
  padding:10px 24px; border-radius:10px;
  background:var(--primary); color:white;
  border:none; font-weight:700; cursor:pointer; font-size:14px;
}

/* Azan banner animation */
@keyframes fadeInDown{
  from{ opacity:0; transform:translateX(-50%) translateY(-20px); }
  to{   opacity:1; transform:translateX(-50%) translateY(0); }
}

/* â•â• PRAYER ROW â•â• */
.p-prayer-row{
  display:flex; align-items:center; gap:0;
}
.p-prayer-item{
  display:flex; flex-direction:column;
}
.p-prayer-divider{
  width:1px; height:32px;
  background:rgba(255,255,255,.2);
  margin:0 12px; flex-shrink:0;
}
.p-curr{ font-size:13px !important; opacity:.85; }
@media(max-width:420px){
  .p-prayer-divider{ margin:0 8px; }
  .p-name{ font-size:13px; }
}

/* â•â• CONNECTING ANIMATION â•â• */
@keyframes dotPulse{
  0%,20%{ content:"â³ Connecting"; }
  33%{ content:"â³ Connecting Â·"; }
  66%{ content:"â³ Connecting Â·Â·"; }
  100%{ content:"â³ Connecting Â·Â·Â·"; }
}
.connecting-dots::after{
  content:"â³ Connecting";
  animation: dotPulse 1.5s infinite steps(1);
}
.connecting-dots{ font-size:0; }
.connecting-dots::after{ font-size:13px; }


/* â•â• FOCUS MODE â•â• */
body.focus-mode #stickyTop,
body.focus-mode #hadithCard,
body.focus-mode #botBtn,
body.focus-mode .audio-floater,
body.focus-mode .word-popup{ display:none !important; }

body.focus-mode{ background:#fdf6e3; }

body.focus-mode main{
  max-width:720px; padding:20px 24px;
}

body.focus-mode .ayah{
  background:transparent;
  box-shadow:none;
  border-bottom:1px solid rgba(0,0,0,.07);
  border-radius:0;
  padding:28px 10px;
  margin-bottom:0;
}

body.focus-mode .arabic{
  font-size:clamp(26px,5vw,42px);
  line-height:2.2;
  color:#1a1a1a;
}

body.focus-mode .translation{
  font-size:16px;
  color:#555;
  line-height:1.8;
  margin-top:12px;
}

body.focus-mode .translation.hidden{ display:none; }

body.focus-mode .bookmark{ display:none; }

/* Ayah number in focus mode â€” mushaf style */
body.focus-mode .ayah-num{
  display:inline-flex; align-items:center; justify-content:center;
  width:32px; height:32px;
  border:1.5px solid var(--primary);
  border-radius:50%;
  font-size:11px; font-weight:700;
  color:var(--primary);
  margin-right:8px;
  font-family:'Amiri',serif;
  flex-shrink:0;
  vertical-align:middle;
}
body.focus-night .ayah-num{
  border-color:#22c55e !important;
  color:#22c55e !important;
}

body.focus-mode .ayah > div:last-child{ display:none; }

/* Focus toolbar â€” fixed top */
#focusToolbar{
  display:none;
  position:fixed; top:0; left:0; width:100%;
  background:rgba(22,101,52,.95);
  backdrop-filter:blur(8px);
  z-index:9999;
  padding:10px 16px;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  box-shadow:0 2px 12px rgba(0,0,0,.2);
}
body.focus-mode #focusToolbar{ display:flex; }
body.focus-mode main{ padding-top:60px; }

.focus-title{
  color:white; font-weight:700; font-size:15px;
  flex:1; text-align:center;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.focus-btn{
  background:rgba(255,255,255,.15);
  border:1px solid rgba(255,255,255,.25);
  color:white; border-radius:8px;
  padding:6px 12px; cursor:pointer;
  font-size:12px; font-weight:700;
  white-space:nowrap; flex-shrink:0;
  transition:.2s;
}
.focus-btn:hover{ background:rgba(255,255,255,.28); }
.focus-btn.active{ background:rgba(255,255,255,.35); outline:1px solid white; }

/* Font size control */
.focus-font-ctrl{
  display:flex; align-items:center; gap:6px; flex-shrink:0;
}
.focus-font-ctrl span{ color:rgba(255,255,255,.7); font-size:11px; }
.focus-font-btn{
  background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.25);
  color:white; border-radius:6px; width:28px; height:28px;
  cursor:pointer; font-size:14px; font-weight:700;
  display:flex; align-items:center; justify-content:center;
}

/* Night mode in focus */
body.focus-night{ background:#1a1a1a !important; }
body.focus-night .ayah{ border-bottom-color:rgba(255,255,255,.08) !important; }
body.focus-night .arabic{ color:#f5f0e8 !important; }
body.focus-night .translation{ color:#aaa !important; }


/* â•â• LEARN PANEL â•â• */
.learn-panel{
  position:fixed; top:0; right:-660px;
  width:640px; height:100%;
  background:white; transition:.3s;
  z-index:10000; display:flex; flex-direction:column;
  box-shadow:-4px 0 20px rgba(0,0,0,.15);
}
.learn-panel.open{ right:0; }
.learn-header{
  background:var(--primary); color:white;
  padding:14px 16px; flex-shrink:0;
  display:flex; align-items:center; justify-content:space-between;
}
.learn-header span{ font-weight:700; font-size:16px; }
.learn-header button{ background:rgba(255,255,255,.2); color:white; padding:6px 14px; }
.learn-tabs{
  display:flex; border-bottom:2px solid #d1fae5;
  background:#f0fdf4; flex-shrink:0;
}
.learn-tab{
  flex:1; padding:11px 6px; text-align:center;
  font-weight:600; font-size:12px; cursor:pointer;
  border:none; background:transparent; color:#6b7280;
  border-bottom:3px solid transparent; margin-bottom:-2px;
  transition:.2s;
}
.learn-tab.active{ color:var(--primary); border-bottom-color:var(--primary); background:white; }
.learn-body{ flex:1; overflow-y:auto; padding:16px; }

/* Transliteration line under Arabic */
.transliteration{
  font-size:13px; color:#6b7280; font-style:italic;
  line-height:1.8; margin-top:4px; display:none;
  direction:ltr; text-align:left;
}
.transliteration.show{ display:block; }

/* Alphabet grid */
.alpha-grid{
  display:grid; grid-template-columns:repeat(4,1fr);
  gap:8px; margin-top:8px;
}
.alpha-card{
  background:#f0fdf4; border:1px solid #d1fae5;
  border-radius:10px; padding:10px 6px;
  text-align:center;
}
.alpha-letter{
  font-family:'Amiri',serif; font-size:28px;
  color:var(--primary); display:block; line-height:1.4;
}
.alpha-name{ font-size:11px; font-weight:700; color:#374151; }
.alpha-roman{ font-size:10px; color:#6b7280; }
.alpha-forms{
  font-family:'Amiri',serif; font-size:12px;
  color:#6b7280; margin-top:3px; direction:rtl;
}

/* Tajweed guide */
.tajweed-rule{
  display:flex; align-items:flex-start; gap:12px;
  padding:12px; border-radius:10px; margin-bottom:8px;
}
.tajweed-dot{
  width:14px; height:14px; border-radius:50%;
  flex-shrink:0; margin-top:3px;
}
.tajweed-name{ font-weight:700; font-size:13px; margin-bottom:3px; }
.tajweed-desc{ font-size:12px; color:#6b7280; line-height:1.6; }
.tajweed-example{
  font-family:'Amiri',serif; font-size:18px;
  color:var(--primary); margin-top:4px;
}

@media(max-width:680px){
  .learn-panel{ width:100%; right:-100%; }
  .learn-panel.open{ right:0; }
  .alpha-grid{ grid-template-columns:repeat(3,1fr); }
}

/* â•â• RESPONSIVE â•â• */
@media(max-width:680px){
  .p-grid{ grid-template-columns:repeat(4,1fr); }
  .bot-panel{ width:100%; right:-100%; }
  .bot-panel.open{ right:0; }
  .tafsir-panel{
    top:auto; bottom:-100%; right:0;
    width:100%; height:92dvh;
    border-radius:20px 20px 0 0;
    transition:bottom .3s ease;
    box-shadow:0 -4px 20px rgba(0,0,0,.2);
  }
  .tafsir-panel.open{ bottom:0; }
  .tafsir-body{ font-size:14px; padding:14px; }
  .p-dt-item{ padding:2px 6px; }
  .p-dt-item .p-dt-label{ display:none; }
}
@media(max-width:420px){
  .p-grid{ grid-template-columns:repeat(3,1fr); }
  #pClock{ font-size:12px; }
}
</style>
</head>
<body>


<!-- â•â• FOCUS TOOLBAR â•â• -->
<div id="focusToolbar">
  <button class="focus-btn" onclick="exitFocus()">âœ• Exit Focus</button>
  <span class="focus-title" id="focusSurahName">Quran</span>
  <div class="focus-font-ctrl">
    <button class="focus-font-btn" onclick="focusFont(-2)">Aâˆ’</button>
    <button class="focus-font-btn" onclick="focusFont(+2)">A+</button>
  </div>
  <button class="focus-btn" id="focusPlayBtn" onclick="toggleFocusPlay()">â–¶</button>
  <button class="focus-btn" id="focusTransBtn" onclick="toggleFocusTrans()">Tr</button>
  <button class="focus-btn" id="focusNightBtn" onclick="toggleFocusNight()">ğŸŒ™</button>
</div>

<!-- â•â• STICKY TOP â•â• -->
<div id="stickyTop">

<header>
  <div class="header-top">
    <h2>ğŸ•Œ Quran Companion</h2>
  </div>
  <div class="header-selects">
    <select id="surahSelect"></select>
    <select id="reciterSelect">
      <option value="Alafasy_128kbps">Mishary Rashid Alafasy</option>
      <option value="Abdurrahmaan_As-Sudais_192kbps">Abdurrahman Al-Sudais</option>
      <option value="Saood_ash-Shuraym_128kbps">Saud Al-Shuraim</option>
      <option value="Husary_128kbps">Mahmoud Al-Husary</option>
      <option value="Abdul_Basit_Murattal_192kbps">Abdul Basit</option>
    </select>
  </div>
  <div class="header-btns">
    <button id="studyBtn" onclick="toggleStudy()">ğŸ“– Study</button>
    <button onclick="enterFocus()" title="Focus Mode">ğŸ¯ Focus</button>
    <button onclick="openLearn()" title="Learn Arabic">ğŸ“š Learn</button>
    <button onclick="playFull()">â–¶ Play</button>
    <button onclick="pauseAudio()">â¸ Pause</button>
    <button onclick="stopAudio()">â¹ Stop</button>
  </div>
</header>

<!-- â•â• PRAYER BAR â•â• -->
<div id="prayerBar">

  <!-- Date / Time row â€” always visible -->
  <div class="p-datetime-row">
    <div class="p-dt-item">
      <span class="p-dt-label">Time</span>
      <span class="p-dt-value" id="pClock">--:--:-- --</span>
    </div>
    <div class="p-dt-item">
      <span class="p-dt-label">Date</span>
      <span class="p-dt-value" id="pGregorian">--</span>
    </div>
    <div class="p-dt-item">
      <span class="p-dt-label">Hijri</span>
      <span class="p-dt-value" id="pHijriInline">--</span>
    </div>
    <div class="p-dt-item" id="pWeatherItem" style="display:none">
      <span class="p-dt-value" id="pWeather">--</span>
    </div>
  </div>

  <!-- Next prayer strip -->
  <div class="p-strip" onclick="togglePanel()">
    <!-- Current -->
    <div class="p-strip-col">
      <span class="p-label">Current</span>
      <span class="p-name p-curr" id="pCurrName">â€”</span>
    </div>
    <!-- Divider -->
    <div class="p-vline"></div>
    <!-- Next -->
    <div class="p-strip-col">
      <span class="p-label">Next</span>
      <span class="p-name" id="pNextName">ğŸ“ Locatingâ€¦</span>
      <span class="p-time" id="pNextTime"></span>
    </div>
    <!-- Divider -->
    <div class="p-vline"></div>
    <!-- Countdown -->
    <div class="p-strip-col p-strip-center">
      <span id="pCountdownLabel" class="p-label">ends in</span>
      <div class="p-countdown" id="pCountdown">--:--</div>
    </div>
    <!-- Buttons -->
    <div class="p-strip-btns" onclick="event.stopPropagation()">
      <button class="p-icon-btn" id="azanBtn" onclick="toggleAzan()">ğŸ””</button>
      <button class="p-icon-btn" id="pExpandBtn" onclick="togglePanel()">â–¼</button>
    </div>
  </div>

  <!-- Expanded panel -->
  <div class="p-panel" id="pPanel">

    <div class="p-grid" id="pGrid"></div>

    <!-- City search -->
    <div class="p-city-row" style="margin-top:12px">
      <input class="p-city-input" id="cityInput" type="text"
        placeholder="City name or ZIP codeâ€¦"
        onkeydown="if(event.key==='Enter')searchCity()">
      <button class="p-search-btn" onclick="searchCity()">ğŸ”</button>
      <button class="p-gps-btn" onclick="requestGPS()" title="Use my current location">ğŸ“ Use My Location</button>
    </div>
    <div class="p-location" id="pLocation">Detecting locationâ€¦</div>

    <!-- Calc + Asr -->
    <div class="p-settings">
      <select id="calcMethod" onchange="savePS();fetchPrayerTimes()">
        <option value="3">Muslim World League</option>
        <option value="2">ISNA â€“ North America</option>
        <option value="5">Egyptian General Authority</option>
        <option value="1">University of Karachi</option>
        <option value="4">Umm Al-Qura (Makkah)</option>
        <option value="16">Dubai</option>
        <option value="9">Kuwait</option>
        <option value="10">Qatar</option>
        <option value="11">Singapore / Malaysia</option>
        <option value="13">Diyanet Ä°ÅŸleri â€“ Turkey</option>
        <option value="7">Tehran (Shia)</option>
      </select>
      <select id="asrMethod" onchange="savePS();fetchPrayerTimes()">
        <option value="0">Asr: Standard (Shafi'i Â· Maliki Â· Hanbali)</option>
        <option value="1">Asr: Hanafi</option>
      </select>
    </div>

    <!-- Azan -->
    <div class="p-azan-row">
      <span class="p-azan-label">ğŸ•Œ Azan:</span>
      <select id="azanSelect" onchange="savePS()">
        <option value="makkah">Makkah</option>
        <option value="madinah">Madinah</option>
        <option value="aqsa">Al-Aqsa</option>
        <option value="turkey">Turkish style</option>
      </select>
    </div>

    <!-- Tools: Masjid + Qibla -->
    <div class="p-tools-row">
      <button class="p-tool-btn" onclick="findMasjid()">ğŸ•Œ Nearest Masjid</button>
      <button class="p-tool-btn" onclick="openQibla()">ğŸ§­ Qibla Direction</button>
    </div>

    <!-- Masjid list -->
    <div class="masjid-list" id="masjidList"></div>

  </div>
</div>
</div><!-- /stickyTop -->

<!-- â•â• HADITH CARD â•â• -->
<div id="hadithCard">
  <div class="hadith-card-inner">
    <div class="hadith-header" onclick="toggleHadith()">
      <div class="hadith-header-left">
        <span class="hadith-title">ğŸ“¿ Hadith</span>
        <span class="hadith-preview" id="hadithPreview">Loading hadith of the dayâ€¦</span>
      </div>
      <button class="p-icon-btn" id="hadithExpandBtn" style="background:rgba(255,255,255,.12)">â–¼</button>
    </div>
    <div class="hadith-tabs-bar" id="hadithTabsBar">
      <button class="h-tab active" id="htab1" onclick="switchHTab(1)">ğŸ“¿ Hadith of the Day</button>
      <button class="h-tab" id="htab2" onclick="switchHTab(2)">ğŸ” Search Hadiths</button>
    </div>
    <div class="hadith-body" id="hadithBody">
      <!-- Tab 1: Hadith of the day -->
      <div id="hPane1">
        <div class="hadith-text" id="hadithText">Loadingâ€¦</div>
        <div class="hadith-meta" id="hadithMeta"></div>
        <div style="margin-top:10px">
          <button onclick="loadHadith()" style="background:rgba(255,255,255,.2);color:white;border:none;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:12px;font-weight:600">ğŸ”„ New Hadith</button>
        </div>
      </div>
      <!-- Tab 2: Search -->
      <div id="hPane2" style="display:none">
        <div class="hadith-search-row">
          <input class="hadith-search-input" id="hadithSearchInput" type="text"
            placeholder="Search topic e.g. patience, prayer, fastingâ€¦"
            onkeydown="if(event.key==='Enter')searchHadith()">
          <button class="hadith-search-btn" onclick="searchHadith()">Search</button>
        </div>
        <div id="hadithResults"></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• MAIN â•â• -->
<main><div id="ayahContainer"></div></main>

<!-- Audio floater -->
<div class="audio-floater" id="audioFloater">
  <div class="progress-bar"><div class="progress" id="progress"></div></div>
  <div class="floater-controls">
    <div id="nowPlaying"></div>
    <div>
      <button onclick="pauseAudio()">â¸</button>
      <button onclick="stopAudio()">â¹</button>
    </div>
  </div>
</div>

<!-- Tafsir panel -->
<div class="tafsir-panel" id="tafsirPanel">
  <div class="tafsir-header">
    <span id="tafsirTitle">Tafsir</span>
    <button onclick="closeTafsir()">âœ• Close</button>
  </div>
  <div class="tafsir-toolbar">
    <label><input type="checkbox" id="compareToggle"> Compare</label>
    <select id="tafseer1">
      <option value="169">Ibn Kathir</option>
      <option value="168">Jalalayn</option>
    </select>
    <span id="vsLabel" style="color:#666;font-size:13px;display:none">vs</span>
    <select id="tafseer2" disabled>
      <option value="168">Jalalayn</option>
      <option value="169">Ibn Kathir</option>
    </select>
  </div>
  <div class="tafsir-tabs" id="tafsirTabs">
    <button class="tafsir-tab active" id="tab1" onclick="switchTab(1)"></button>
    <button class="tafsir-tab"        id="tab2" onclick="switchTab(2)"></button>
  </div>
  <div class="tafsir-body" id="tafsirBody">
    <p style="color:#aaa;text-align:center;margin-top:40px">Tap "Tafsir" on any verse to begin.</p>
  </div>
</div>

<!-- Islamic Q&A Bot panel -->
<div class="bot-panel" id="botPanel">
  <div class="bot-header">
    <div class="bot-header-left">
      <h3>ğŸ•Œ Islamic Q&amp;A</h3>
      <small>Powered by Gemini AI Â· Quran &amp; Sunnah</small>
    </div>
    <button onclick="closeBot()">âœ•</button>
  </div>
  <div class="bot-messages" id="botMessages">
    <div class="bot-msg assistant">
      Assalamu Alaikum! ğŸ‘‹<br><br>
      I can answer questions about the Quran, Hadith, Islamic history, and Islamic practice â€” always with source references.<br><br>
      <em style="font-size:11px;opacity:.7">Ask me anything Islamic, e.g. "What does the Quran say about patience?" or "Hadith about honesty"</em>
    </div>
  </div>
  <div class="bot-disclaimer">
    âš ï¸ Always verify rulings with a qualified scholar. This is for educational purposes only.
  </div>
  <div class="bot-input-row">
    <textarea class="bot-input" id="botInput" rows="1"
      placeholder="Ask about Quran or Sunnahâ€¦"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendBotMsg()}"
      oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
    <button class="bot-send-btn" id="botSendBtn" onclick="sendBotMsg()">â¤</button>
  </div>
</div>

<!-- Bot floating button -->
<button id="botBtn" onclick="toggleBot()" title="Islamic Q&A">ğŸ¤²</button>

<!-- Word popup -->
<div class="word-popup" id="wordPopup"></div>

<!-- Azan audio -->
<audio id="azanAudio" preload="none"></audio>

<!-- Qibla overlay -->
<div id="qiblaOverlay">
  <div class="qibla-box">
    <h3>ğŸ§­ Qibla Direction</h3>
    <p id="qiblaSubtitle">Calculatingâ€¦</p>
    <p style="font-size:11px;color:#6b7280;margin:-8px 0 10px;background:#f0fdf4;padding:6px 10px;border-radius:8px;">
      ğŸ’¡ On laptop: use this angle with a physical compass or phone compass to face Qibla.<br>
      On mobile: the angle auto-updates with device orientation.
    </p>
    <div class="compass-wrap">
      <div class="compass-rose" id="compassRose">
        <div class="compass-n">N</div>
        <div class="compass-needle" id="compassNeedle">
          <div class="needle-south"></div>
          <div class="needle-north"></div>
        </div>
        <div class="kaaba-icon">ğŸ•‹</div>
      </div>
    </div>
    <div class="qibla-degrees" id="qiblaDeg">--Â°</div>
    <div class="qibla-direction" id="qiblaDir">from North</div>
    <button class="qibla-close-btn" onclick="closeQibla()">Close</button>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BACKEND URL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BACKEND = "https://quran-companion-backend-q9zk.onrender.com";

/* Smart fetch â€” retries on 504 (Render cold start gateway timeout) */
async function backendFetch(url, options={}, maxRetries=4){
  for(let attempt=1; attempt<=maxRetries; attempt++){
    try{
      const res=await fetch(url,{...options, signal:AbortSignal.timeout(60000)});
      if(res.status===504){
        // Server was sleeping â€” it is now waking up, wait and retry
        console.log(`Backend 504 on attempt ${attempt}, retrying in ${attempt*8}s...`);
        await new Promise(r=>setTimeout(r, attempt*8000));
        continue;
      }
      return res;
    } catch(e){
      if(attempt===maxRetries) throw e;
      await new Promise(r=>setTimeout(r, attempt*5000));
    }
  }
  throw new Error("Backend unreachable after "+maxRetries+" attempts");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIVE CLOCK + DATES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateClock(){
  const now = new Date();
  // Time
  pClock.textContent = now.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"});
  // Gregorian
  pGregorian.textContent = now.toLocaleDateString([],{weekday:"short",month:"short",day:"numeric",year:"numeric"});
}
setInterval(updateClock, 1000);
updateClock();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRAYER TIMES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const AZAN_SRCS = {
  makkah:  "https://www.islamcan.com/audio/adhan/azan1.mp3",
  madinah: "https://www.islamcan.com/audio/adhan/azan2.mp3",
  aqsa:    "https://www.islamcan.com/audio/adhan/azan3.mp3",
  turkey:  "https://www.islamcan.com/audio/adhan/azan4.mp3"
};

const PRAYERS = [
  { key:"Fajr",    icon:"ğŸŒ™", name:"Fajr",    azan:true  },
  { key:"Sunrise", icon:"ğŸŒ…", name:"Sunrise",  azan:false },
  { key:"Ishraq",  icon:"ğŸŒ„", name:"Ishraq",   azan:false },
  { key:"Dhuhr",   icon:"â˜€ï¸", name:"Dhuhr",   azan:true  },
  { key:"Asr",     icon:"ğŸŒ¤ï¸", name:"Asr",     azan:true  },
  { key:"Maghrib", icon:"ğŸŒ‡", name:"Maghrib",  azan:true  },
  { key:"Isha",    icon:"ğŸŒƒ", name:"Isha",     azan:true  },
];
function getPrayerName(p){
  if(p.key==="Asr" && document.getElementById("asrMethod")?.value==="1")
    return "Asr (Hanafi)";
  return p.name;
}

let pCoords=null, pTimeObjs=null, pExpanded=false;
let azanOn=true, pTickTimer=null, lastAzanFired={};

const _calc=localStorage.getItem("pCalc")||"3";
const _asr =localStorage.getItem("pAsr") ||"0";
const _azan=localStorage.getItem("pAzan")||"makkah";
const _mute=localStorage.getItem("pMute")||"0";
document.getElementById("calcMethod").value=_calc;
document.getElementById("asrMethod").value=_asr;
document.getElementById("azanSelect").value=_azan;
azanOn=_mute!=="1";
refreshAzanBtn();

function savePS(){
  localStorage.setItem("pCalc",calcMethod.value);
  localStorage.setItem("pAsr", asrMethod.value);
  localStorage.setItem("pAzan",azanSelect.value);
}
function togglePanel(){
  pExpanded=!pExpanded;
  pPanel.classList.toggle("open",pExpanded);
  pExpandBtn.textContent=pExpanded?"â–²":"â–¼";
}
function toggleAzan(){ azanOn=!azanOn; localStorage.setItem("pMute",azanOn?"0":"1"); refreshAzanBtn(); }
function refreshAzanBtn(){
  azanBtn.textContent=azanOn?"ğŸ””":"ğŸ”•";
  azanBtn.title=azanOn?"Azan ON â€“ tap to mute":"Azan OFF â€“ tap to unmute";
}

function requestGPS(){
  // First load saved coords instantly while waiting for GPS
  const saved=localStorage.getItem("pCoords");
  if(saved){
    pCoords=JSON.parse(saved);
    const savedLabel=localStorage.getItem("pCoordsLabel");
    pLocation.textContent=savedLabel||"ğŸ“ Last known location";
    fetchPrayerTimes();
  }
  pLocation.textContent=(saved?"ğŸ“ Updating locationâ€¦":"ğŸ“ Detectingâ€¦");
  pNextName.textContent=(saved?pNextName.textContent:"ğŸ“ Locatingâ€¦");
  if(!navigator.geolocation){
    if(!saved) pLocation.textContent="Geolocation not supported. Search a city above.";
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos=>{
      pCoords={lat:pos.coords.latitude,lng:pos.coords.longitude};
      localStorage.setItem("pCoords",JSON.stringify(pCoords));
      reverseGeocode(pCoords.lat,pCoords.lng);
      fetchPrayerTimes();
    },
    ()=>{
      if(!saved){
        pLocation.textContent="GPS denied. Search a city or ZIP above.";
        pNextName.textContent="ğŸ“ Location needed";
      }
    },
    {timeout:10000, enableHighAccuracy:false}
  );
}

async function searchCity(){
  const q=cityInput.value.trim(); if(!q) return;
  cityInput.disabled=true; pLocation.textContent="ğŸ” Searchingâ€¦";
  try{
    // Support zip codes: if all digits, add countrycodes=us for better results
    const isZip=/^\d{4,6}$/.test(q.replace(/\s/g,""));
    const extra=isZip?"&countrycodes=us,gb,ca,au&addressdetails=1":"";
    const r=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=1${extra}`);
    const d=await r.json();
    if(!d.length){
      pLocation.textContent=isZip?"ZIP code not found. Try a city name instead.":"City not found.";
      cityInput.disabled=false; return;
    }
    pCoords={lat:parseFloat(d[0].lat),lng:parseFloat(d[0].lon)};
    localStorage.setItem("pCoords",JSON.stringify(pCoords));
    const label=d[0].display_name.split(",").slice(0,3).join(", ");
    pLocation.textContent="ğŸ“ "+label;
    localStorage.setItem("pCoordsLabel","ğŸ“ "+label);
    cityInput.value="";
    fetchPrayerTimes();
  } catch(e){ pLocation.textContent="Search failed. Check connection."; }
  cityInput.disabled=false;
}

async function reverseGeocode(lat,lng){
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
    const d=await r.json();
    const a=d.address;
    const city=a?.city||a?.town||a?.village||a?.county||"";
    const country=a?.country||"";
    const label=`ğŸ“ ${city}${country?", "+country:""}`;
    pLocation.textContent=label;
    localStorage.setItem("pCoordsLabel",label);
  } catch(e){ pLocation.textContent=`ğŸ“ ${lat.toFixed(3)}, ${lng.toFixed(3)}`; }
}

/* Weather code to description */
function weatherDesc(code){
  if(code===0) return "â˜€ï¸";
  if(code<=2) return "ğŸŒ¤ï¸";
  if(code<=3) return "â˜ï¸";
  if(code<=48) return "ğŸŒ«ï¸";
  if(code<=57) return "ğŸŒ§ï¸";
  if(code<=67) return "ğŸŒ§ï¸";
  if(code<=77) return "ğŸŒ¨ï¸";
  if(code<=82) return "ğŸŒ§ï¸";
  if(code<=86) return "â„ï¸";
  if(code<=99) return "â›ˆï¸";
  return "ğŸŒ¡ï¸";
}

async function fetchWeather(){
  if(!pCoords) return;
  try{
    const{lat,lng}=pCoords;
    const r=await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}`+
      `&current=temperature_2m,apparent_temperature,weathercode`+
      `&temperature_unit=fahrenheit&timezone=auto`
    );
    const d=await r.json();
    const c=d.current;
    const icon=weatherDesc(c.weathercode);
    const tempF=Math.round(c.temperature_2m);
    const tempC=Math.round((c.temperature_2m-32)*5/9);
    const feelsF=Math.round(c.apparent_temperature);
    pWeather.textContent=`${icon} ${tempF}Â°F / ${tempC}Â°C`;
    pWeather.title=`Feels like ${feelsF}Â°F`;
    pWeatherItem.style.display="flex";
  } catch(e){ console.log("Weather:",e); }
}

async function fetchPrayerTimes(){
  if(!pCoords){ pNextName.textContent="ğŸ“ Location needed"; return; }
  pNextName.textContent="â³ Loadingâ€¦";
  try{
    const now=new Date();
    const url=`https://api.aladhan.com/v1/timings/${now.getDate()}-${now.getMonth()+1}-${now.getFullYear()}`
             +`?latitude=${pCoords.lat}&longitude=${pCoords.lng}&method=${calcMethod.value}&school=${asrMethod.value}`;
    const r=await fetch(url);
    const d=await r.json();
    if(d.code!==200) throw new Error("API error");

    /* Hijri date */
    const h=d.data.date.hijri;
    pHijriInline.textContent=`${h.day} ${h.month.en} ${h.year} AH`;

    buildTimeObjects(now, d.data.timings);
    renderGrid();
    updateStrip();
    fetchWeather();
    clearInterval(pTickTimer);
    pTickTimer=setInterval(()=>{ updateStrip(); checkAzanTrigger(); },1000);
  } catch(err){
    console.error(err);
    pNextName.textContent="âš ï¸ Could not load times";
  }
}

function parseTime(str,ref){
  const[h,m]=str.split(":").map(Number);
  const d=new Date(ref); d.setHours(h,m,0,0); return d;
}

function buildTimeObjects(now,t){
  const sunrise=parseTime(t.Sunrise,now);
  pTimeObjs={
    Fajr:   parseTime(t.Fajr,   now),
    Sunrise:sunrise,
    Ishraq: new Date(sunrise.getTime()+15*60000),
    Dhuhr:  parseTime(t.Dhuhr,  now),
    Asr:    parseTime(t.Asr,    now),
    Maghrib:parseTime(t.Maghrib,now),
    Isha:   parseTime(t.Isha,   now),
  };
}

function fmt(d){ return d?d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"--:--"; }

function renderGrid(){
  if(!pTimeObjs) return;
  const now=new Date();
  let curKey=null;
  for(const p of PRAYERS){ if(pTimeObjs[p.key]&&pTimeObjs[p.key]<=now) curKey=p.key; }
  pGrid.innerHTML=PRAYERS.map(p=>{
    const t=pTimeObjs[p.key];
    const passed=t&&t<now&&p.key!==curKey;
    const current=p.key===curKey;
    return `<div class="p-cell ${current?"current":""} ${passed?"passed":""}">
      <div class="p-cell-icon">${p.icon}</div>
      <div class="p-cell-name">${getPrayerName(p)}</div>
      <div class="p-cell-time">${fmt(t)}</div>
    </div>`;
  }).join("");
}

function updateStrip(){
  if(!pTimeObjs) return;
  const now=new Date();
  let next=PRAYERS.find(p=>pTimeObjs[p.key]&&pTimeObjs[p.key]>now);
  if(!next) next=PRAYERS[0];
  // Current prayer = last prayer whose time has passed
  let curr=null;
  for(const p of PRAYERS){ if(pTimeObjs[p.key]&&pTimeObjs[p.key]<=now) curr=p; }
  if(curr) pCurrName.textContent=curr.icon+" "+getPrayerName(curr);
  else pCurrName.textContent="â€”";
  pNextName.textContent=next.icon+" "+getPrayerName(next);
  pNextTime.textContent=fmt(pTimeObjs[next.key]);
  const diff=Math.max(0,pTimeObjs[next.key]-now);
  const h=Math.floor(diff/3600000);
  const m=Math.floor((diff%3600000)/60000);
  const s=Math.floor((diff%60000)/1000);
  const countdownStr=h>0?`${h}h ${String(m).padStart(2,"0")}m`:`${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  pCountdown.textContent=countdownStr;
  // Label: "Dhuhr ends in" or "Asr in"
  if(curr){
    pCountdownLabel.textContent=getPrayerName(curr)+" ends in";
  } else {
    pCountdownLabel.textContent=getPrayerName(next)+" starts in";
  }
  if(s===0) renderGrid();
}

function checkAzanTrigger(){
  if(!pTimeObjs||!azanOn) return;
  const now=new Date(); const today=now.toDateString();
  for(const p of PRAYERS){
    if(!p.azan) continue;
    const t=pTimeObjs[p.key]; if(!t) continue;
    const diff=now-t;
    if(diff>=0&&diff<60000){
      const uid=p.key+"_"+today;
      if(!lastAzanFired[uid]){ lastAzanFired[uid]=true; playAzan(p.name); }
    }
  }
}

function playAzan(prayerName){
  const src=AZAN_SRCS[azanSelect.value]||AZAN_SRCS.makkah;
  azanAudio.src=src; azanAudio.currentTime=0;
  azanAudio.play().catch(()=>{});
  showAzanBanner(prayerName);
}

function showAzanBanner(name){
  const b=document.createElement("div");
  b.style.cssText=`position:fixed;top:20px;left:50%;transform:translateX(-50%);
    background:linear-gradient(135deg,#065f46,#166534);color:white;
    padding:14px 28px;border-radius:16px;font-size:16px;font-weight:700;
    z-index:99999;box-shadow:0 8px 25px rgba(0,0,0,.4);
    text-align:center;animation:fadeInDown .4s ease;white-space:nowrap;`;
  b.innerHTML=`ğŸ•Œ Time for <strong>${name}</strong>`;
  document.body.appendChild(b);
  setTimeout(()=>b.remove(),9000);
}

/* Midnight refresh */
setInterval(()=>{
  const n=new Date();
  if(n.getHours()===0&&n.getMinutes()===0&&n.getSeconds()<5){
    lastAzanFired={};
    if(pCoords) fetchPrayerTimes();
  }
},5000);

requestGPS();

/* â”€â”€ LOCATION PERMISSION NOTICE â”€â”€
   The browser asks for location every time with local files (file://).
   We load saved location instantly and only re-request GPS silently.
   To avoid the popup permanently: host the file on a web server,
   or in Chrome go to Settings â†’ Privacy â†’ Site Settings â†’ Location
   and add an exception for this file. */

/* Wake up Render server on page load + keep alive every 14 min */
(async function pingServer(){
  try{ await fetch(`${BACKEND}/`,{method:"GET",signal:AbortSignal.timeout(60000)}); } catch(e){}
})();
setInterval(async()=>{
  try{ await fetch(`${BACKEND}/`,{method:"GET",signal:AbortSignal.timeout(10000)}); } catch(e){}
}, 14 * 60 * 1000); // 14 minutes â€” Render sleeps after 15

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEAREST MASJID (OpenStreetMap Overpass API)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function findMasjid(){
  const list=document.getElementById("masjidList");
  if(!pCoords){
    list.className="masjid-list open";
    list.innerHTML='<div class="masjid-item">ğŸ“ Please enable location or search a city first.</div>';
    return;
  }
  list.className="masjid-list open";
  list.innerHTML='<div class="masjid-item">ğŸ” Finding nearby masjidsâ€¦</div>';
  try{
    const {lat,lng}=pCoords;
    const radius=10000;
    const query=`[out:json][timeout:25];(node["amenity"="place_of_worship"]["religion"="muslim"](around:${radius},${lat},${lng});way["amenity"="place_of_worship"]["religion"="muslim"](around:${radius},${lat},${lng});relation["amenity"="place_of_worship"]["religion"="muslim"](around:${radius},${lat},${lng}););out center 20;`;
    const url=`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
    const res=await fetch(url,{signal:AbortSignal.timeout(20000)});
    if(!res.ok) throw new Error("API "+res.status);
    const data=await res.json();
    if(!data.elements||!data.elements.length){
      list.innerHTML='<div class="masjid-item">No masjids found within 10km. Try searching a different city above.</div>';
      return;
    }
    const withDist=data.elements.map(el=>{
      const elLat=Number(el.lat||(el.center&&el.center.lat)||0);
      const elLng=Number(el.lon||(el.center&&el.center.lon)||0);
      const tags=el.tags||{};
      const name=tags.name||tags["name:en"]||tags["name:ar"]||
                 tags["name:ur"]||tags["name:tr"]||tags.operator||"Masjid";
      return{elLat,elLng,name,dist:calcDist(lat,lng,elLat,elLng)};
    }).filter(el=>el.elLat&&el.elLng).sort((a,b)=>a.dist-b.dist);
    list.innerHTML=withDist.slice(0,10).map(el=>{
      const distStr=el.dist<1?(el.dist*1000).toFixed(0)+" m":el.dist.toFixed(2)+" km";
      const mapsUrl=`https://www.google.com/maps/search/?api=1&query=${el.elLat},${el.elLng}`;
      const dirsUrl=`https://www.google.com/maps/dir/?api=1&destination=${el.elLat},${el.elLng}`;
      return `<div class="masjid-item">
        <div class="masjid-name">ğŸ•Œ ${el.name}</div>
        <div class="masjid-dist">ğŸ“ ${distStr} away &nbsp;Â·&nbsp;
          <a href="${mapsUrl}" target="_blank" style="color:var(--accent);text-decoration:none">View â†—</a> &nbsp;Â·&nbsp;
          <a href="${dirsUrl}" target="_blank" style="color:var(--accent);text-decoration:none">Directions â†—</a>
        </div>
      </div>`;
    }).join("");
  } catch(e){
    console.error("Masjid:",e);
    list.innerHTML=`<div class="masjid-item">Could not load automatically.
      <br><a href="https://www.google.com/maps/search/mosque+near+me" target="_blank"
        style="color:var(--accent);text-decoration:none">ğŸ” Search on Google Maps â†—</a></div>`;
  }
}

function calcDist(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QIBLA FINDER (pure math)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MAKKAH={lat:21.4225,lng:39.8262};

function openQibla(){
  if(!pCoords){ alert("Please enable location first."); return; }
  qiblaOverlay.classList.add("open");
  const{lat,lng}=pCoords;
  const dLng=(MAKKAH.lng-lng)*Math.PI/180;
  const lat1=lat*Math.PI/180;
  const lat2=MAKKAH.lat*Math.PI/180;
  const y=Math.sin(dLng)*Math.cos(lat2);
  const x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLng);
  let bearing=Math.atan2(y,x)*180/Math.PI;
  bearing=(bearing+360)%360;

  qiblaAngle=bearing;
  qiblaDeg.textContent=bearing.toFixed(1)+"Â°";
  qiblaDir.textContent=getCardinal(bearing)+" from North";
  qiblaSubtitle.textContent="From your location toward Makkah";
  compassNeedle.style.transform=`translate(-50%,-100%) rotate(${bearing}deg)`;
  compassRose.style.transform=`rotate(${-bearing}deg)`;
  startCompass();
}

function getCardinal(deg){
  const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  return dirs[Math.round(deg/22.5)%16];
}

let qiblaAngle=0;
let compassListener=null;

function startCompass(){
  if(window.DeviceOrientationEvent){
    if(typeof DeviceOrientationEvent.requestPermission==="function"){
      // iOS 13+
      DeviceOrientationEvent.requestPermission().then(state=>{
        if(state==="granted") listenCompass();
      }).catch(()=>{});
    } else {
      listenCompass();
    }
  }
}

function listenCompass(){
  compassListener=e=>{
    const heading = e.webkitCompassHeading || (e.alpha ? (360 - e.alpha) : null);
    if(heading===null||heading===undefined) return;
    // Rotate the compass rose so North always points up relative to device
    const rose=document.getElementById("compassRose");
    if(rose) rose.style.transform=`rotate(${heading - qiblaAngle}deg)`;
  };
  window.addEventListener("deviceorientation", compassListener);
}

function closeQibla(){
  qiblaOverlay.classList.remove("open");
  if(compassListener){
    window.removeEventListener("deviceorientation", compassListener);
    compassListener=null;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HADITH CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let hadithExpanded=false;
let activeHTab=1;

function toggleHadith(){
  hadithExpanded=!hadithExpanded;
  hadithBody.classList.toggle("open",hadithExpanded);
  hadithTabsBar.classList.toggle("open",hadithExpanded);
  hadithExpandBtn.textContent=hadithExpanded?"â–²":"â–¼";
  if(hadithExpanded){
    const txt=hadithText.textContent.trim();
    const isEmpty=!txt||txt==="Loadingâ€¦"||txt.startsWith("Could not")||txt.startsWith("Server waking");
    if(isEmpty) loadHadith();
  }
}

function switchHTab(n){
  activeHTab=n;
  htab1.classList.toggle("active",n===1);
  htab2.classList.toggle("active",n===2);
  hPane1.style.display=n===1?"block":"none";
  hPane2.style.display=n===2?"block":"none";
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HADITH â€” BUILT-IN COLLECTION (instant, no server)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const HADITHS=[
  {n:"Abu Huraira (RA)",c:"Sahih Bukhari",num:"1",g:"Sahih",
   e:"Actions are judged by intentions, and every person will get the reward according to what he has intended."},
  {n:"Aisha (RA)",c:"Sahih Bukhari",num:"6018",g:"Sahih",
   e:"The Prophet (ï·º) said: 'The most beloved of deeds to Allah are those that are most consistent, even if they are small.'"},
  {n:"Abu Huraira (RA)",c:"Sahih Muslim",num:"2564",g:"Sahih",
   e:"Do not envy one another, do not artificially raise prices against one another, do not hate one another, do not turn away from one another, and do not undercut one another in trade. Be servants of Allah and brothers to one another."},
  {n:"Abdullah ibn Masud (RA)",c:"Sahih Bukhari",num:"6094",g:"Sahih",
   e:"Truthfulness leads to righteousness and righteousness leads to Paradise. A man keeps speaking the truth until he is recorded with Allah as a truthful person."},
  {n:"Abu Huraira (RA)",c:"Sahih Muslim",num:"223",g:"Sahih",
   e:"Cleanliness is half of faith."},
  {n:"Anas ibn Malik (RA)",c:"Sahih Bukhari",num:"13",g:"Sahih",
   e:"None of you truly believes until he loves for his brother what he loves for himself."},
  {n:"Abu Huraira (RA)",c:"Sahih Bukhari",num:"5673",g:"Sahih",
   e:"The strong person is not the one who overcomes people by his strength, but the one who controls himself while in anger."},
  {n:"Ibn Abbas (RA)",c:"Sahih Bukhari",num:"6412",g:"Sahih",
   e:"Take advantage of five matters before five other matters: your youth before you become old; your health before you fall sick; your wealth before you become poor; your free time before you become preoccupied; and your life before your death."},
  {n:"Abu Huraira (RA)",c:"Sahih Muslim",num:"2699",g:"Sahih",
   e:"Whoever follows a path in pursuit of knowledge, Allah will make easy for him a path to Paradise."},
  {n:"Abdullah ibn Amr (RA)",c:"Sahih Bukhari",num:"4798",g:"Sahih",
   e:"The merciful are shown mercy by the Most Merciful. Be merciful to those on earth and the One above the heavens will have mercy upon you."},
  {n:"Abu Huraira (RA)",c:"Sahih Bukhari",num:"6475",g:"Sahih",
   e:"Allah said: I am as my servant thinks of Me, and I am with him when he remembers Me."},
  {n:"Aisha (RA)",c:"Sahih Bukhari",num:"2009",g:"Sahih",
   e:"Whoever introduces into this affair of ours something that does not belong to it, it is rejected."},
  {n:"Abu Huraira (RA)",c:"Sahih Muslim",num:"2626",g:"Sahih",
   e:"A good man treats women with honour and a despicable man treats women with degradation."},
  {n:"Abu Dharr (RA)",c:"Sahih Muslim",num:"2588",g:"Sahih",
   e:"Do not consider any act of kindness insignificant, even meeting your brother with a cheerful face."},
  {n:"Abu Huraira (RA)",c:"Sahih Bukhari",num:"2442",g:"Sahih",
   e:"Whoever relieves a Muslim of a burden from the burdens of the world, Allah will relieve him of a burden from the burdens of the Hereafter."},
  {n:"Muadh ibn Jabal (RA)",c:"Tirmidhi",num:"2616",g:"Sahih",
   e:"Fear Allah wherever you are, follow a bad deed with a good one and it will erase it, and treat people with good character."},
  {n:"Abu Huraira (RA)",c:"Sahih Bukhari",num:"6507",g:"Sahih",
   e:"Allah the Exalted says: I am as my servant expects Me to be, and I am with him when he remembers Me."},
  {n:"Abdullah ibn Umar (RA)",c:"Sahih Bukhari",num:"6416",g:"Sahih",
   e:"Be in this world as though you are a stranger or a traveller."},
  {n:"Abu Huraira (RA)",c:"Sahih Muslim",num:"2607",g:"Sahih",
   e:"Part of the perfection of one's Islam is his leaving that which does not concern him."},
  {n:"Anas ibn Malik (RA)",c:"Tirmidhi",num:"1987",g:"Sahih",
   e:"Make things easy and do not make things difficult. Give good news and do not repel people."},
  {n:"Abu Huraira (RA)",c:"Sahih Bukhari",num:"5765",g:"Sahih",
   e:"There is a piece of flesh in the body; if it is sound, the whole body is sound, and if it is corrupt, the whole body is corrupt. Verily it is the heart."},
  {n:"Abu Huraira (RA)",c:"Sahih Muslim",num:"2162",g:"Sahih",
   e:"The rights of one Muslim over another are six: when you meet him, greet him; when he invites you, accept; when he seeks your advice, advise him sincerely; when he sneezes and praises Allah, say yarhamukallah; when he is sick, visit him; when he dies, follow his funeral."},
  {n:"Abdullah ibn Masud (RA)",c:"Sahih Bukhari",num:"5765",g:"Sahih",
   e:"No one should wish for death because of a calamity that has befallen him. If he must do so, let him say: O Allah, keep me alive as long as life is good for me, and cause me to die when death is good for me."},
  {n:"Abu Huraira (RA)",c:"Sahih Bukhari",num:"3",g:"Sahih",
   e:"The first thing revealed was: Read in the name of your Lord who created â€” created man from a clinging substance."},
  {n:"Jabir (RA)",c:"Sahih Muslim",num:"1017",g:"Sahih",
   e:"Whoever starts a good practice in Islam has its reward and the reward of all who follow it, without their rewards being diminished."},
  {n:"Abu Huraira (RA)",c:"Sahih Bukhari",num:"6502",g:"Sahih",
   e:"When a man dies, his deeds come to an end except for three: a continuing charity, knowledge that benefits others, or a righteous son who prays for him."},
  {n:"Aisha (RA)",c:"Sahih Muslim",num:"746",g:"Sahih",
   e:"The most beloved prayer to the Prophet (ï·º) was the one that was done regularly even if it were little."},
  {n:"Abu Huraira (RA)",c:"Sahih Bukhari",num:"1358",g:"Sahih",
   e:"Every child is born upon fitrah (natural disposition). His parents then make him a Jew, a Christian, or a Magian."},
  {n:"Anas ibn Malik (RA)",c:"Sahih Bukhari",num:"6010",g:"Sahih",
   e:"By the One in Whose Hand my soul is, none of you truly believes until he loves for his neighbour what he loves for himself."},
  {n:"Abu Huraira (RA)",c:"Sahih Muslim",num:"2996",g:"Sahih",
   e:"The world is a prison for the believer and a paradise for the disbeliever."},
];

let lastHadithIndex=-1;

function loadHadith(){
  // Pick a random hadith different from the last one â€” instant, no server
  let idx;
  do { idx=Math.floor(Math.random()*HADITHS.length); } while(idx===lastHadithIndex&&HADITHS.length>1);
  lastHadithIndex=idx;
  const h=HADITHS[idx];
  hadithText.className="hadith-text";
  hadithText.textContent=`"${h.e}"`;
  hadithMeta.textContent=`${h.n} Â· ${h.c} ${h.num} Â· ${h.g}`;
  hadithPreview.textContent=h.e.length>80?h.e.substring(0,80)+"â€¦":h.e;
}

async function searchHadith(){
  const q=hadithSearchInput.value.trim();
  if(!q) return;

  // Always show local results first â€” instant
  const qLow=q.toLowerCase();
  const local=HADITHS.filter(h=>h.e.toLowerCase().includes(qLow)||h.n.toLowerCase().includes(qLow));
  if(local.length){
    hadithResults.innerHTML=`<div style="opacity:.6;font-size:11px;padding:4px 0 8px">
      Showing ${local.length} result${local.length>1?"s":""} from built-in collection Â· searching full literatureâ€¦
    </div>`+local.map(h=>`
      <div class="hadith-result">
        <div>"${h.e}"</div>
        <div class="hadith-result-meta">${h.n} Â· ${h.c} ${h.num} Â· ${h.g}</div>
      </div>`).join("");
  } else {
    hadithResults.innerHTML='<div style="opacity:.7;font-size:12px;padding:8px 0">â³ Searching full hadith literatureâ€¦</div>';
  }

  // Then fetch from backend for deeper results
  try{
    const r=await backendFetch(`${BACKEND}/hadith/search?q=${encodeURIComponent(q)}`);
    const d=await r.json();
    if(!d.results||!d.results.length){
      if(!local.length)
        hadithResults.innerHTML='<div style="opacity:.7;font-size:12px;padding:8px 0">No results found. Try: fasting, prayer, patience, charity, parentsâ€¦</div>';
      return;
    }
    // Show backend results (replace local)
    hadithResults.innerHTML=`<div style="opacity:.6;font-size:11px;padding:4px 0 8px">
      ${d.results.length} result${d.results.length>1?"s":""} from full hadith literature
    </div>`+d.results.map(h=>`
      <div class="hadith-result">
        <div>"${h.ENGLISH||h.English||h.english||""}"</div>
        <div class="hadith-result-meta">
          ${h.NARRATOR||h.Narrator||""} Â· ${h.COLLECTION||h.Collection||""} ${h.NUMBER||h.Number||""} Â· ${h.GRADE||h.Grade||""}
        </div>
      </div>`).join("");
  } catch(e){
    if(!local.length)
      hadithResults.innerHTML='<div style="opacity:.7;font-size:12px;padding:8px 0">Could not reach server. Showing local results only.</div>';
  }
}

/* Load hadith instantly on startup */
loadHadith();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ISLAMIC Q&A BOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let botOpen=false;
let botTyping=false;

function toggleBot(){ botOpen?closeBot():openBot(); }
function openBot(){ botOpen=true; botPanel.classList.add("open"); botBtn.textContent="âœ•"; }
function closeBot(){ botOpen=false; botPanel.classList.remove("open"); botBtn.textContent="ğŸ¤²"; }

/* Islamic topic keywords â€” client-side pre-filter */
const ISLAMIC_KEYWORDS = [
  "quran","surah","ayah","verse","allah","prophet","muhammad","islam","muslim",
  "hadith","sunnah","salah","prayer","fasting","zakat","hajj","ramadan","eid",
  "wudu","ghusl","halal","haram","dua","dhikr","tafsir","iman","tawbah",
  "jannah","jahannam","angels","jinn","qibla","masjid","mosque","ummah",
  "sahaba","companion","caliphate","seerah","hijra","mecca","makkah","madinah",
  "quran","sunnah","fiqh","fatwa","scholar","imam","khutbah","friday",
  "tahajjud","witr","ishraq","asr","fajr","maghrib","isha","dhuhr",
  "bismillah","alhamdulillah","subhanallah","inshallah","mashallah",
  "taqwa","sabr","patience","gratitude","charity","orphan","parents",
  "marriage","divorce","inheritance","nikaah","talaq","riba","interest",
  "sin","repentance","forgiveness","mercy","compassion","justice","truth",
  "arabic","tajweed","memorize","memorization","hifz","hafiz",
  "how many","how","what","when","where","who","why","which","tell me",
  "explain","meaning","definition","describe","difference","between"
];

function isIslamicQuestion(q){
  const lower = q.toLowerCase();
  return ISLAMIC_KEYWORDS.some(kw => lower.includes(kw));
}

async function sendBotMsg(){
  const input=botInput;
  const q=input.value.trim();
  if(!q||botTyping) return;
  input.value=""; input.style.height="auto";

  appendBotMsg(q,"user");

  /* Client-side topic filter */
  if(!isIslamicQuestion(q)){
    appendBotMsg(
      "I can only answer questions related to Islam, the Quran, Hadith, Salah, and Islamic practice. Please ask me something Islamic! ğŸ•Œ",
      "assistant"
    );
    return;
  }

  botTyping=true;
  botSendBtn.disabled=true;

  const loadingEl=appendBotMsg("","assistant loading connecting-dots");

  /* Wake-up warning after 5 seconds */
  const wakeTimer=setTimeout(()=>{
    if(loadingEl.isConnected){
      loadingEl.className="bot-msg assistant";
      loadingEl.textContent="â³ Server waking up after sleep â€” retrying automatically, please waitâ€¦";
    }
  }, 8000);

  try{
    const timeoutId=null;
    const r=await backendFetch(`${BACKEND}/ask`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({question:q})
    });
    clearTimeout(timeoutId);
    clearTimeout(wakeTimer);
    const d=await r.json();
    loadingEl.remove();
    appendBotMsg(d.answer||"Sorry, I could not process that.","assistant");
  } catch(e){
    clearTimeout(wakeTimer);
    loadingEl.remove();
    if(e.name==="AbortError"){
      appendBotMsg("Server took too long to respond. Please try again in a moment â€” it may have been sleeping.","assistant");
    } else {
      appendBotMsg("Connection error. Please check your internet and try again.","assistant");
    }
  }

  botTyping=false;
  botSendBtn.disabled=false;
}

function appendBotMsg(text,cls){
  const el=document.createElement("div");
  el.className="bot-msg "+cls;
  el.textContent=text;
  botMessages.appendChild(el);
  botMessages.scrollTop=botMessages.scrollHeight;
  return el;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QURAN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let verses=[],chaptersData=[],quranAudio=new Audio();
let studyMode=false,currentIndex=0,currentTafsirKey=null;
let bookmarks=JSON.parse(localStorage.getItem("bookmarks")||"{}");
let translitOn=false; // transliteration toggle â€” must be declared before render()

compareToggle.addEventListener("change",function(){
  tafseer2.disabled=!this.checked;
  vsLabel.style.display=this.checked?"inline":"none";
  renderTafsir();
});
tafseer1.addEventListener("change",renderTafsir);
tafseer2.addEventListener("change",renderTafsir);

async function loadSurahNames(){
  const res=await fetch("https://api.quran.com/api/v4/chapters");
  const data=await res.json();
  chaptersData=data.chapters;
  data.chapters.forEach(ch=>{
    let opt=document.createElement("option");
    opt.value=ch.id;
    opt.textContent=ch.id+". "+ch.name_simple;
    surahSelect.appendChild(opt);
  });
  loadSurah(localStorage.getItem("lastSurah")||1);
}

async function loadSurah(id){
  // Always fetch words so transliteration is available even in normal mode
  const url=`https://api.quran.com/api/v4/verses/by_chapter/${id}?translations=20&fields=text_uthmani&words=true&word_fields=text_uthmani,translation,transliteration,root,lemma&per_page=300`;
  const res=await fetch(url);
  const data=await res.json();
  verses=data.verses;
  render();
}

function toggleStudy(){
  studyMode=!studyMode;
  document.getElementById("studyBtn").classList.toggle("active",studyMode);
  loadSurah(surahSelect.value);
}

function render(){
  ayahContainer.innerHTML="";
  verses.forEach((v,i)=>{
    let arabicHTML=v.text_uthmani;
    // Build transliteration from words if available
    let translit="";
    if(v.words) translit=v.words.map(w=>w.transliteration?.text||"").filter(Boolean).join(" ");

    if(studyMode&&v.words){
      arabicHTML=v.words.map(w=>{
        const wData=JSON.stringify(w).replace(/'/g,"&apos;");
        return `<span class="word" onclick="playWordAudio(${i});showWord(JSON.parse(this.getAttribute('data-w')))" data-w='${wData}'>${w.text_uthmani}</span>`;
      }).join(" ");
    }
    let markClass=bookmarks[v.verse_key]?"bookmark bookmarked":"bookmark";
    let div=document.createElement("div");
    div.className="ayah"; div.id="ayah-"+i;
    const ayahNum = v.verse_key.split(":")[1];
    const showTr=translitOn&&translit?"show":"";
    const trText=translit||"(Enable Study Mode for transliteration)";
    div.innerHTML=`
      <span class="${markClass}" onclick="toggleBookmark('${v.verse_key}')">ğŸ”–</span>
      <div class="arabic" onclick="if(!event.target.classList.contains('word'))playWordAudio(${i})"
        style="cursor:pointer" title="Tap to play">${arabicHTML}<span class="ayah-num" title="Ayah ${ayahNum}">${ayahNum}</span></div>
      <div class="transliteration ${showTr}" id="tr-${i}">${trText}</div>
      <div class="translation">${v.translations[0].text}</div>
      <div style="margin-top:10px">
        <button onclick="playSingle(${i})">â–¶ Play</button>
        <button onclick="openTafsir('${v.verse_key}')">ğŸ“š Tafsir</button>
      </div>`;
    ayahContainer.appendChild(div);
  });
}

function showWord(w){
  wordPopup.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
      <div>
        <strong style="font-family:'Amiri',serif;font-size:32px;display:block">${w.text_uthmani}</strong>
        <span style="font-size:14px;color:#6b7280;font-style:italic">${w.transliteration?.text||""}</span>
      </div>
      <button onclick="wordPopup.classList.remove('show')"
        style="background:#e5e7eb;color:#374151;border:none;border-radius:8px;padding:6px 12px;cursor:pointer;font-weight:600">âœ•</button>
    </div>
    <b>Meaning:</b> ${w.translation?.text||"Not available"}<br>
    <b>Root:</b> ${w.root||w.lemma||"Not available"}<br>
    <div style="margin-top:10px;font-size:11px;color:#9ca3af">
      ğŸ’¡ The audio plays the full verse so you hear the word in correct recitation context
    </div>`;
  wordPopup.classList.add("show");
}

function playWordAudio(i){
  // Play just this ayah then stop â€” do not auto-advance
  if(currentIndex===i && !quranAudio.paused){ return; } // already playing this ayah
  currentIndex=i;
  document.querySelectorAll(".ayah").forEach(a=>a.classList.remove("playing"));
  const el=document.getElementById("ayah-"+i);
  if(el) el.classList.add("playing");
  const key=verses[i].verse_key;
  quranAudio.src=buildURL(key);
  quranAudio.play();
  audioFloater.classList.add("show");
  const[s,a]=key.split(":");
  const surahObj=chaptersData.find(c=>c.id==s);
  nowPlaying.textContent=surahObj?`${surahObj.name_simple} â€“ Ayah ${a}`:`Surah ${s} â€“ Ayah ${a}`;
  // Stop after this ayah â€” do not continue
  quranAudio.onended=()=>{
    el.classList.remove("playing");
    audioFloater.classList.remove("show");
    progress.style.width="0%";
    quranAudio.onended=()=>{ currentIndex++; playCurrent(); }; // restore normal behaviour
  };
}

function toggleBookmark(key){
  if(bookmarks[key]) delete bookmarks[key]; else bookmarks[key]=true;
  localStorage.setItem("bookmarks",JSON.stringify(bookmarks));
  render();
}

function buildURL(key){
  const reciter=reciterSelect.value;
  const[s,a]=key.split(":");
  return `https://everyayah.com/data/${reciter}/${s.padStart(3,"0")}${a.padStart(3,"0")}.mp3`;
}

function playSingle(i){ currentIndex=i; playCurrent(); }
function playFull(){ currentIndex=0; playCurrent(); }

function playCurrent(){
  if(currentIndex>=verses.length){ stopAudio(); return; }
  document.querySelectorAll(".ayah").forEach(a=>a.classList.remove("playing"));
  const el=document.getElementById("ayah-"+currentIndex);
  el.classList.add("playing");
  el.scrollIntoView({behavior:"smooth",block:"center"});
  const key=verses[currentIndex].verse_key;
  const[s,a]=key.split(":");
  const surahObj=chaptersData.find(c=>c.id==s);
  quranAudio.src=buildURL(key);
  quranAudio.play();
  nowPlaying.textContent=surahObj?`${surahObj.name_simple} (${s}) â€“ Ayah ${a}`:`Surah ${s} â€“ Ayah ${a}`;
  audioFloater.classList.add("show");
  localStorage.setItem("lastSurah",surahSelect.value);
  localStorage.setItem("lastAyah",currentIndex);
  // Update lock screen controls
  const surahObj2=chaptersData.find(c=>c.id==s);
  updateMediaSession(surahObj2?surahObj2.name_simple:"Quran", a, s);
  quranAudio.onended=()=>{ currentIndex++; playCurrent(); };
}

quranAudio.ontimeupdate=function(){
  if(quranAudio.duration) progress.style.width=(quranAudio.currentTime/quranAudio.duration*100)+"%";
};
function pauseAudio(){ quranAudio.pause(); }
function stopAudio(){
  quranAudio.pause(); quranAudio.currentTime=0;
  audioFloater.classList.remove("show");
  progress.style.width="0%";
}

/* Tafsir */
async function openTafsir(key){
  currentTafsirKey=key;
  tafsirPanel.classList.add("open");
  renderTafsir();
}
let tafsirPaneHTML=["",""]; let activeTab=1;
function switchTab(n){
  activeTab=n;
  tab1.classList.toggle("active",n===1);
  tab2.classList.toggle("active",n===2);
  tafsirBody.innerHTML=`<div class="tafsir-box">${tafsirPaneHTML[n-1]}</div>`;
  tafsirBody.scrollTop=0;
}
async function renderTafsir(){
  if(!currentTafsirKey) return;
  const[s,a]=currentTafsirKey.split(":");
  const surahObj=chaptersData.find(c=>c.id==s);
  tafsirTitle.textContent=surahObj?`${surahObj.name_simple} â€“ Ayah ${a}`:`Surah ${s} â€“ Ayah ${a}`;
  const id1=tafseer1.value,id2=tafseer2.value;
  const compare=compareToggle.checked;
  const label1=tafseer1.options[tafseer1.selectedIndex].text;
  const label2=tafseer2.options[tafseer2.selectedIndex].text;
  tafsirTabs.classList.toggle("show",compare);
  tab1.textContent=label1; tab2.textContent=label2;
  activeTab=1; tab1.classList.add("active"); tab2.classList.remove("active");
  tafsirBody.innerHTML=`<p style="color:#aaa;text-align:center;padding:30px 0">Loadingâ€¦</p>`;
  try{
    if(compare){
      const[r1,r2]=await Promise.all([
        fetch(`https://api.quran.com/api/v4/tafsirs/${id1}/by_ayah/${currentTafsirKey}`),
        fetch(`https://api.quran.com/api/v4/tafsirs/${id2}/by_ayah/${currentTafsirKey}`)
      ]);
      const[d1,d2]=await Promise.all([r1.json(),r2.json()]);
      tafsirPaneHTML[0]=`<h3>${label1}</h3>${d1.tafsir?.text||"<em>Not available</em>"}`;
      tafsirPaneHTML[1]=`<h3>${label2}</h3>${d2.tafsir?.text||"<em>Not available</em>"}`;
    } else {
      const r1=await fetch(`https://api.quran.com/api/v4/tafsirs/${id1}/by_ayah/${currentTafsirKey}`);
      const d1=await r1.json();
      tafsirPaneHTML[0]=`<h3>${label1}</h3>${d1.tafsir?.text||"<em>Not available</em>"}`;
      tafsirPaneHTML[1]="";
    }
    tafsirBody.innerHTML=`<div class="tafsir-box">${tafsirPaneHTML[0]}</div>`;
  } catch(e){
    tafsirBody.innerHTML=`<p style="color:red;padding:20px">Error loading tafsir.</p>`;
  }
}
function closeTafsir(){ tafsirPanel.classList.remove("open"); }

surahSelect.addEventListener("change",e=>{
  localStorage.removeItem("lastAyah");
  loadSurah(e.target.value);
});

loadSurahNames();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PWA â€” Service Worker Registration
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js").catch(e=>console.log("SW:",e));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MEDIA SESSION â€” Lock Screen Controls
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateMediaSession(surahName, ayahNum, surahId){
  if(!("mediaSession" in navigator)) return;
  navigator.mediaSession.metadata = new MediaMetadata({
    title: `Ayah ${ayahNum}`,
    artist: surahName,
    album: "Quran Companion",
    artwork: [
      { src: "icon-192.png", sizes: "192x192", type: "image/png" },
      { src: "icon-512.png", sizes: "512x512", type: "image/png" }
    ]
  });
  navigator.mediaSession.setActionHandler("play", ()=>{ quranAudio.play(); });
  navigator.mediaSession.setActionHandler("pause", ()=>{ quranAudio.pause(); });
  navigator.mediaSession.setActionHandler("previoustrack", ()=>{
    if(currentIndex>0){ currentIndex--; playCurrent(); }
  });
  navigator.mediaSession.setActionHandler("nexttrack", ()=>{
    if(currentIndex<verses.length-1){ currentIndex++; playCurrent(); }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOCUS MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let focusTransVisible=false;
let focusNight=false;
let focusFontDelta=0;

function toggleFocusPlay(){
  const btn=document.getElementById("focusPlayBtn");
  if(quranAudio.paused){
    playFull();
    btn.textContent="â¸";
    btn.classList.add("active");
    // Keep button in sync when audio ends
    quranAudio.addEventListener("ended",function onEnd(){
      if(currentIndex>=verses.length){
        btn.textContent="â–¶";
        btn.classList.remove("active");
        quranAudio.removeEventListener("ended",onEnd);
      }
    });
  } else {
    pauseAudio();
    btn.textContent="â–¶";
    btn.classList.remove("active");
  }
}

function enterFocus(){
  document.body.classList.add("focus-mode");
  document.body.classList.remove("focus-night");
  focusNight=false;
  // Update surah name in toolbar
  const sel=document.getElementById("surahSelect");
  const name=sel.options[sel.selectedIndex]?.text||"Quran";
  document.getElementById("focusSurahName").textContent=name;
  // Arabic only by default â€” hide translations
  focusTransVisible=false;
  applyFocusTrans();
  document.getElementById("focusTransBtn").classList.remove("active");
  window.scrollTo({top:0,behavior:"smooth"});
}

function exitFocus(){
  document.body.classList.remove("focus-mode","focus-night");
  document.querySelectorAll(".translation").forEach(t=>t.classList.remove("hidden"));
  focusFontDelta=0;
  applyFocusFont();
  // Reset play button
  const btn=document.getElementById("focusPlayBtn");
  if(btn){ btn.textContent="â–¶"; btn.classList.remove("active"); }
}

function toggleFocusTrans(){
  focusTransVisible=!focusTransVisible;
  applyFocusTrans();
  document.getElementById("focusTransBtn").classList.toggle("active",focusTransVisible);
}

function applyFocusTrans(){
  document.querySelectorAll(".translation").forEach(t=>{
    if(focusTransVisible) t.classList.remove("hidden");
    else t.classList.add("hidden");
  });
}

function toggleFocusNight(){
  focusNight=!focusNight;
  document.body.classList.toggle("focus-night",focusNight);
  document.getElementById("focusNightBtn").textContent=focusNight?"â˜€ï¸":"ğŸŒ™";
  document.getElementById("focusNightBtn").classList.toggle("active",focusNight);
}

function focusFont(delta){
  focusFontDelta+=delta;
  focusFontDelta=Math.max(-8,Math.min(20,focusFontDelta));
  applyFocusFont();
}

function applyFocusFont(){
  document.querySelectorAll("body.focus-mode .arabic").forEach(el=>{
    el.style.fontSize=focusFontDelta===0?"":
      `clamp(${26+focusFontDelta}px,5vw,${42+focusFontDelta}px)`;
  });
}

// When surah changes in focus mode, update toolbar title
document.getElementById("surahSelect").addEventListener("change",function(){
  if(document.body.classList.contains("focus-mode")){
    const name=this.options[this.selectedIndex]?.text||"Quran";
    document.getElementById("focusSurahName").textContent=name;
  }
});

// ESC key exits focus mode
document.addEventListener("keydown",e=>{
  if(e.key==="Escape"&&document.body.classList.contains("focus-mode")) exitFocus();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEARN PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openLearn(){
  document.getElementById("learnPanel").classList.add("open");
  renderAlphabet();
  renderTajweed();
}
function closeLearn(){
  document.getElementById("learnPanel").classList.remove("open");
}

function switchLTab(n){
  [1,2,3].forEach(i=>{
    document.getElementById("ltab"+i).classList.toggle("active",i===n);
    document.getElementById("lPane"+i).style.display=i===n?"block":"none";
  });
}

function toggleTransliteration(){
  translitOn=!translitOn;
  const btn=document.getElementById("transToggleBtn");
  btn.textContent=translitOn?"Hide Transliteration":"Show Transliteration";
  btn.style.background=translitOn?"#065f46":"var(--primary)";
  document.querySelectorAll(".transliteration").forEach(el=>{
    const hasText=el.textContent&&!el.textContent.includes("Enable Study Mode");
    if(translitOn&&hasText) el.classList.add("show");
    else el.classList.remove("show");
  });
}

/* Arabic Alphabet */
const ALPHABET=[
  {a:"Ø§",n:"Alif",r:"a / Ä",f:"Ø§ Ù€Ø§"},
  {a:"Ø¨",n:"Ba",r:"b",f:"Ø¨Ù€ Ù€Ø¨Ù€ Ù€Ø¨"},
  {a:"Øª",n:"Ta",r:"t",f:"ØªÙ€ Ù€ØªÙ€ Ù€Øª"},
  {a:"Ø«",n:"Tha",r:"th",f:"Ø«Ù€ Ù€Ø«Ù€ Ù€Ø«"},
  {a:"Ø¬",n:"Jim",r:"j",f:"Ø¬Ù€ Ù€Ø¬Ù€ Ù€Ø¬"},
  {a:"Ø­",n:"Ha",r:"á¸¥",f:"Ø­Ù€ Ù€Ø­Ù€ Ù€Ø­"},
  {a:"Ø®",n:"Kha",r:"kh",f:"Ø®Ù€ Ù€Ø®Ù€ Ù€Ø®"},
  {a:"Ø¯",n:"Dal",r:"d",f:"Ø¯ Ù€Ø¯"},
  {a:"Ø°",n:"Dhal",r:"dh",f:"Ø° Ù€Ø°"},
  {a:"Ø±",n:"Ra",r:"r",f:"Ø± Ù€Ø±"},
  {a:"Ø²",n:"Zay",r:"z",f:"Ø² Ù€Ø²"},
  {a:"Ø³",n:"Sin",r:"s",f:"Ø³Ù€ Ù€Ø³Ù€ Ù€Ø³"},
  {a:"Ø´",n:"Shin",r:"sh",f:"Ø´Ù€ Ù€Ø´Ù€ Ù€Ø´"},
  {a:"Øµ",n:"Sad",r:"á¹£",f:"ØµÙ€ Ù€ØµÙ€ Ù€Øµ"},
  {a:"Ø¶",n:"Dad",r:"á¸",f:"Ø¶Ù€ Ù€Ø¶Ù€ Ù€Ø¶"},
  {a:"Ø·",n:"Tta",r:"á¹­",f:"Ø·Ù€ Ù€Ø·Ù€ Ù€Ø·"},
  {a:"Ø¸",n:"Ddha",r:"áº“",f:"Ø¸Ù€ Ù€Ø¸Ù€ Ù€Ø¸"},
  {a:"Ø¹",n:"Ain",r:"Ê¿",f:"Ø¹Ù€ Ù€Ø¹Ù€ Ù€Ø¹"},
  {a:"Øº",n:"Ghain",r:"gh",f:"ØºÙ€ Ù€ØºÙ€ Ù€Øº"},
  {a:"Ù",n:"Fa",r:"f",f:"ÙÙ€ Ù€ÙÙ€ Ù€Ù"},
  {a:"Ù‚",n:"Qaf",r:"q",f:"Ù‚Ù€ Ù€Ù‚Ù€ Ù€Ù‚"},
  {a:"Ùƒ",n:"Kaf",r:"k",f:"ÙƒÙ€ Ù€ÙƒÙ€ Ù€Ùƒ"},
  {a:"Ù„",n:"Lam",r:"l",f:"Ù„Ù€ Ù€Ù„Ù€ Ù€Ù„"},
  {a:"Ù…",n:"Mim",r:"m",f:"Ù…Ù€ Ù€Ù…Ù€ Ù€Ù…"},
  {a:"Ù†",n:"Nun",r:"n",f:"Ù†Ù€ Ù€Ù†Ù€ Ù€Ù†"},
  {a:"Ù‡",n:"Ha",r:"h",f:"Ù‡Ù€ Ù€Ù‡Ù€ Ù€Ù‡"},
  {a:"Ùˆ",n:"Waw",r:"w / Å«",f:"Ùˆ Ù€Ùˆ"},
  {a:"ÙŠ",n:"Ya",r:"y / Ä«",f:"ÙŠÙ€ Ù€ÙŠÙ€ Ù€ÙŠ"},
];

function renderAlphabet(){
  const g=document.getElementById("alphaGrid");
  if(g.children.length) return;
  g.innerHTML=ALPHABET.map(l=>`
    <div class="alpha-card">
      <span class="alpha-letter">${l.a}</span>
      <div class="alpha-name">${l.n}</div>
      <div class="alpha-roman">${l.r}</div>
      <div class="alpha-forms">${l.f}</div>
    </div>`).join("");
}

/* Tajweed rules */
const TAJWEED=[
  {color:"#16a34a",name:"Ghunnah (ØºÙ†Ø©)",
   desc:"A nasal sound held for 2 counts. Occurs on Noon (Ù†) or Mim (Ù…) with a shaddah.",
   ex:"Ø¥ÙÙ†ÙÙ‘ Â· Ù…ÙÙ…ÙÙ‘Ø§"},
  {color:"#2563eb",name:"Ikhfa (Ø¥Ø®ÙØ§Ø¡)",
   desc:"Hidden pronunciation â€” Noon Sakin or Tanwin is partially hidden before 15 letters.",
   ex:"Ù…ÙÙ†Ù’ ÙƒÙØ§Ù†Ù"},
  {color:"#dc2626",name:"Idgham (Ø¥Ø¯ØºØ§Ù…)",
   desc:"Merging â€” Noon Sakin or Tanwin merges into the next letter.",
   ex:"Ù…ÙÙ† ÙŠÙÙ‚ÙÙˆÙ„Ù"},
  {color:"#9333ea",name:"Iqlab (Ø¥Ù‚Ù„Ø§Ø¨)",
   desc:"Conversion â€” Noon Sakin or Tanwin changes to a Mim sound before Ba (Ø¨).",
   ex:"Ù…ÙÙ†Ù’ Ø¨ÙØ¹Ù’Ø¯Ù"},
  {color:"#ea580c",name:"Izhar (Ø¥Ø¸Ù‡Ø§Ø±)",
   desc:"Clear pronunciation â€” Noon Sakin or Tanwin is pronounced clearly before 6 throat letters.",
   ex:"Ù…ÙÙ†Ù’ Ø£ÙØ±ÙØ§Ø¯Ù"},
  {color:"#ca8a04",name:"Madd (Ù…Ø¯)",
   desc:"Elongation â€” stretching a vowel sound for 2, 4, or 6 counts depending on the type.",
   ex:"Ù‚ÙØ§Ù„ÙÙˆØ§ Â· Ø¬ÙØ§Ø¡Ù"},
  {color:"#0891b2",name:"Qalqalah (Ù‚Ù„Ù‚Ù„Ø©)",
   desc:"Echoing bounce â€” occurs on letters Ù‚ Ø· Ø¨ Ø¬ Ø¯ when they have a sukoon.",
   ex:"ÙŠÙØ·Ù’Ù…ÙØ¹Ù Â· Ù‚ÙØ¯Ù’"},
];

function renderTajweed(){
  const el=document.getElementById("tajweedList");
  if(el.children.length) return;
  el.innerHTML=TAJWEED.map(r=>`
    <div class="tajweed-rule" style="background:${r.color}15;border:1px solid ${r.color}30">
      <div class="tajweed-dot" style="background:${r.color}"></div>
      <div>
        <div class="tajweed-name" style="color:${r.color}">${r.name}</div>
        <div class="tajweed-desc">${r.desc}</div>
        <div class="tajweed-example">${r.ex}</div>
      </div>
    </div>`).join("");
}

</script>

<!-- â•â• LEARN PANEL â•â• -->
<div class="learn-panel" id="learnPanel">
  <div class="learn-header">
    <span>ğŸ“š Learn Arabic & Tajweed</span>
    <button onclick="closeLearn()">âœ• Close</button>
  </div>
  <div class="learn-tabs">
    <button class="learn-tab active" id="ltab1" onclick="switchLTab(1)">ğŸ”¤ Transliteration</button>
    <button class="learn-tab" id="ltab2" onclick="switchLTab(2)">Ø£ Alphabet</button>
    <button class="learn-tab" id="ltab3" onclick="switchLTab(3)">ğŸ¨ Tajweed</button>
  </div>
  <div class="learn-body" id="learnBody">

    <!-- Tab 1: Transliteration -->
    <div id="lPane1">
      <p style="color:#374151;font-size:13px;line-height:1.7;margin-bottom:16px">
        Transliteration shows Arabic words written in English letters so you can read along 
        even before learning the Arabic script. It appears below each verse.
      </p>
      <div style="background:#f0fdf4;border:1px solid #d1fae5;border-radius:12px;padding:16px;margin-bottom:16px">
        <div style="font-weight:700;color:var(--primary);margin-bottom:8px;font-size:14px">Example:</div>
        <div style="font-family:'Amiri',serif;font-size:24px;direction:rtl;text-align:right;margin-bottom:6px">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</div>
        <div style="font-size:13px;color:#6b7280;font-style:italic">BismillÄhi r-raá¸¥mÄni r-raá¸¥Ä«m</div>
        <div style="font-size:13px;color:#374151;margin-top:4px">In the name of Allah, the Entirely Merciful, the Especially Merciful.</div>
      </div>
      <button onclick="toggleTransliteration()" id="transToggleBtn"
        style="width:100%;padding:12px;border-radius:10px;background:var(--primary);
        color:white;border:none;font-size:14px;font-weight:700;cursor:pointer;margin-bottom:12px">
        Show Transliteration
      </button>
      <p style="font-size:11px;color:#9ca3af;line-height:1.6;text-align:center">
        ğŸ’¡ Tip: Transliteration helps with pronunciation but learning Arabic script 
        gives you a much deeper connection with the Quran.
      </p>
    </div>

    <!-- Tab 2: Arabic Alphabet -->
    <div id="lPane2" style="display:none">
      <p style="color:#374151;font-size:13px;line-height:1.7;margin-bottom:12px">
        Arabic has 28 letters. Each letter changes shape depending on its position in a word.
      </p>
      <div class="alpha-grid" id="alphaGrid"></div>
    </div>

    <!-- Tab 3: Tajweed -->
    <div id="lPane3" style="display:none">
      <p style="color:#374151;font-size:13px;line-height:1.7;margin-bottom:12px">
        Tajweed are the rules of Quran recitation. These are the main rules you will encounter:
      </p>
      <div id="tajweedList"></div>
    </div>

  </div>
</div>

</body>
</html>
